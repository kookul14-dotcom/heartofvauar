<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Board: Final Complete</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
<style>
    /* -------------------------------------------
       CORE STYLES
    ------------------------------------------- */
    :root {
        --bg-color: #0d1117; --panel-bg: #161b22; 
        --text-color: #c9d1d9; --accent: #58a6ff;
        --p1-color: #2ea043; --p2-color: #da3633; --gold: #f2cc60;
        --rare: #a371f7; --legend: #d29922;
        --highlight: #39d353;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body {
        height: 100dvh; margin: 0; overflow: hidden;
        display: flex; justify-content: center; background-color: #000;
        font-family: 'Noto Sans KR', sans-serif;
    }
    #game-wrapper {
        width: 100%; max-width: 600px; height: 100dvh; position: relative;
        display: flex; flex-direction: column; background: var(--bg-color);
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    
    /* Animations */
    @keyframes breath { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)} }
    @keyframes flash-red { 0%,100%{box-shadow:inset 0 0 0 0 red;} 50%{box-shadow:inset 0 0 50px 20px rgba(255,0,0,0.4);} }
    .flash-damage { animation: flash-red 0.3s linear; }
    @keyframes floatUp { 0%{transform:translateY(0);opacity:1} 100%{transform:translateY(-40px);opacity:0} }
    .float-text { position: absolute; font-family:'Black Han Sans'; font-size: 16px; text-shadow: 2px 2px 0 #000; animation: floatUp 1.2s forwards; z-index: 999; pointer-events: none; width: 140px; text-align: center; left:50%; margin-left:-70px; }

    /* UI Components */
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10; display: none; flex-direction: column; }
    .active-screen { display: flex; }
    .font-header { font-family: 'Do Hyeon', sans-serif; }
    button { cursor: pointer; border: none; outline: none; transition: 0.1s; font-family: 'Do Hyeon'; }
    button:active { transform: scale(0.96); filter: brightness(0.9); }
    .btn-main { width: 100%; padding: 14px; font-size: 18px; border-radius: 8px; background: linear-gradient(135deg, #1f6feb, #1158c7); color: white; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .btn-main:disabled { background: #333; color: #777; box-shadow: none; transform:none; }

    /* HUD */
    #hud { position: absolute; top: 0; left: 0; width: 100%; background: rgba(13, 17, 23, 0.95); backdrop-filter: blur(5px); border-bottom: 1px solid #30363d; padding: 5px; z-index: 50; display: flex; flex-direction: column; gap: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .top-info { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; font-size: 12px; color: #8b949e; }
    .player-hud-grid { display: flex; gap: 5px; height: 120px; }
    .p-panel { flex: 1; background: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 6px; display: flex; flex-direction: column; justify-content: space-between; position: relative; transition: border-color 0.3s; }
    .p-panel.active-turn { border: 1px solid var(--gold); box-shadow: inset 0 0 10px rgba(242, 204, 96, 0.1); }
    .char-header { display: flex; align-items: center; gap: 5px; margin-bottom: 2px; }
    .char-icon { width: 30px; height: 30px; background: #21262d; border-radius: 4px; display:flex; align-items:center; justify-content:center; font-size:16px; border: 1px solid #30363d; overflow: hidden; }
    .char-icon img { width: 100%; height: 100%; object-fit: contain; }
    .char-info { display: flex; flex-direction: column; flex: 1; }
    .char-name { font-size: 12px; font-weight: bold; color: var(--text-color); line-height: 1.1; }
    .char-job { font-size: 10px; color: #8b949e; }
    .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 4px; font-size: 10px; color: #c9d1d9; margin-bottom: 2px; }
    .s-item { display: flex; align-items: center; gap: 2px; }
    .s-val { color: var(--text-color); font-family: 'Do Hyeon'; letter-spacing: 0.5px; }
    .equip-tray { display: flex; gap: 2px; flex-wrap: wrap; margin-top: auto; }
    .eq-slot { width: 16px; height: 16px; background: #0d1117; border: 1px solid #30363d; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #484f58; overflow:hidden; }
    .eq-slot.filled { border-color: #8b949e; color: #fff; }
    .art-slot { width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--gold); display:flex; align-items:center; justify-content:center; font-size:9px; background:#342a08; }
    .boss-bar-wrap { height: 20px; background: #222; border: 1px solid #dba6a6; position: relative; border-radius: 4px; overflow: hidden; margin-top: 2px; }
    .boss-hp-fill { height: 100%; background: #da3633; width: 100%; transition: width 0.3s; }
    .boss-text { position:absolute; width:100%; text-align:center; top:0; font-size:11px; color:white; font-weight:bold; line-height:20px; text-shadow:1px 1px 1px black; }

    /* Board */
    #board-container { flex: 1; overflow-x: auto; overflow-y: hidden; background: #010409; position: relative; }
    #grid { display: grid; grid-template-columns: repeat(50, 1fr); height: 100%; width: 3200px; padding-bottom: 80px; align-items: end; background: url('images/map_bg.png') center/cover no-repeat; }
    .tile { height: 60px; position: relative; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #21262d; font-size: 10px; color: #555; }
    .tile-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; position: absolute; bottom: 0; z-index: 0; }
    .tile-txt { z-index: 1; text-shadow: 1px 1px 2px black; font-weight: bold; position: relative; }
    .pawn, .obj-wrap { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 1px; height: 1px; z-index: 20; pointer-events: none; display: flex; justify-content: center; align-items: flex-end; }
    .game-img-asset { width: 80px; height: 80px; object-fit: contain; animation: breath 2s infinite ease-in-out; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.7)); }

    /* Modals & Setup */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-box { width: 90%; max-width: 380px; background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; }
    
    .battle-header { text-align: center; font-size: 20px; color: var(--gold); margin-bottom: 10px; text-shadow: 0 2px 4px black; }
    .battle-stage { display: flex; justify-content: space-between; align-items: center; background: #0d1117; padding: 10px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 10px; position: relative; }
    .fighter-card { width: 42%; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .f-img-box { width: 70px; height: 70px; background: #21262d; border-radius: 8px; border: 2px solid #30363d; margin-bottom: 5px; position: relative; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .f-img-box img { width: 100%; height: 100%; object-fit: contain; }
    .f-name { font-size: 12px; font-weight: bold; color: white; margin-bottom: 2px; white-space: nowrap; }
    .f-hp-bar { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-bottom: 4px; }
    .f-hp-fill { height: 100%; width: 100%; transition: width 0.3s; }
    .vs-badge { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #da3633; color: white; font-weight: bold; font-size: 14px; padding: 4px 8px; border-radius: 12px; border: 2px solid #0d1117; z-index: 5; }
    .stat-compare { display: grid; grid-template-columns: 1fr auto 1fr; gap: 5px; font-size: 11px; color: #8b949e; margin-top: 5px; width: 100%; }
    .sc-val { font-family: 'Do Hyeon'; font-size: 13px; color: #c9d1d9; }
    .sc-label { color: #58a6ff; font-weight: bold; }
    .battle-log-area { max-height: 120px; overflow-y: auto; background: #010409; border: 1px solid #30363d; border-radius: 6px; padding: 8px; font-size: 11px; color: #8b949e; margin-bottom: 10px; text-align: left; line-height: 1.4; }
    .log-line { margin-bottom: 2px; border-bottom: 1px dashed #21262d; padding-bottom: 2px; }
    .log-hlt { color: var(--gold); font-weight: bold; }
    .log-dmg { color: var(--p2-color); }

    /* Gacha & Setup UI */
    .gacha-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; width: 100%; }
    .merc-card { background: #1f2428; border: 1px solid #444; border-radius: 6px; padding: 10px; text-align: center; }
    .merc-card.legend { border-color: var(--legend); background: #291e0a; box-shadow: inset 0 0 10px rgba(210,153,34,0.3); }
    .merc-card.rare { border-color: var(--rare); background: #1e1529; }
    .merc-title { font-weight: bold; font-size: 12px; margin-bottom: 8px; color: #ddd; }
    .merc-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 12px; color: white; }
    .stat-box { display: flex; align-items: center; justify-content: center; gap: 4px; }
    .stat-val { font-family: 'Do Hyeon'; color: white; }
    .stat-max { color: var(--highlight); font-weight: bold; font-size: 1.3em; text-shadow: 0 0 8px rgba(57,211,83,0.6); transform: scale(1.1); }

    .hand-container { display: flex; gap: 8px; padding: 10px; background: #0d1117; border: 1px dashed #30363d; border-radius: 8px; margin-bottom: 10px; min-height: 100px; overflow-x: auto; align-items: center; }
    .dragger { width: 75px; height: 95px; background: #21262d; border: 1px solid #8b949e; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 5px; cursor: grab; flex-shrink: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .dragger.placed { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
    .d-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 11px; width: 100%; text-align: center; color:white; }

    /* Shop UI */
    .shop-item { display: flex; align-items: center; background: #21262d; padding: 8px; margin-bottom: 5px; border-radius: 6px; gap: 10px; }
    .shop-img-box { width: 50px; height: 50px; background: #0d1117; border-radius: 4px; display: flex; align-items: center; justify-content: center; border: 1px solid #30363d; overflow: hidden; flex-shrink: 0; }
    .shop-img-box img { width: 100%; height: 100%; object-fit: contain; }
    .shop-info { flex: 1; }

    #controls { background: #161b22; border-top: 1px solid #30363d; padding: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 60; }
    .ctrl-row { display: flex; gap: 8px; height: 45px; }
    .c-btn { flex: 1; background: #21262d; border: 1px solid #30363d; color: #c9d1d9; border-radius: 6px; font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.1; }
    .c-btn.active { border-color: var(--gold); background: #342a08; color: var(--gold); }
    .roll-btn { background: var(--p1-color); color: white; font-size: 20px; border-radius: 6px; height: 50px; font-weight: bold; box-shadow: 0 4px 0 #1b6629; margin-bottom: 5px; }
    .roll-btn:disabled { background: #333; box-shadow: none; color: #555; }

    .class-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
    .class-card { background: #21262d; border: 1px solid #30363d; border-radius: 8px; padding: 10px; text-align: center; }
    .slot-container { display: flex; justify-content: space-around; gap: 5px; margin-bottom: 10px; }
    .stat-slot { width: 70px; height: 90px; background: #0d1117; border: 2px dashed #30363d; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #8b949e; position: relative; }
    .stat-slot.filled { border-style: solid; background: #1f2428; }
    .choice-btn { width: 100%; padding: 10px; background: #21262d; border: 1px solid #30363d; color: white; border-radius: 6px; margin-bottom: 5px; text-align: left; }
</style>
</head>
<body>

<div id="game-wrapper">
    <div id="screen-class" class="screen active-screen" style="padding:20px; overflow-y:auto;">
        <h2 class="font-header" style="color:white; text-align:center;">ÏßÄÎèÑÏûê ÏÑ†ÌÉù</h2>
        <div class="class-grid" id="class-list"></div>
    </div>

    <div id="screen-setup" class="screen" style="padding:15px; display:none;">
        <div id="phase-gacha" style="flex:1; display:flex; flex-direction:column; justify-content:center;">
            <h2 class="font-header" style="color:var(--gold); text-align:center;">Ïö©Î≥ëÎã® ÏÜåÌôò</h2>
            <div class="gacha-grid" id="gacha-view"></div>
            <button class="btn-main" id="btn-summon" onclick="Setup.summon()">ÏÜåÌôò (0/4)</button>
        </div>
        <div id="phase-place" style="flex:1; display:none; flex-direction:column;">
            <div style="text-align:center; color:#8b949e; font-size:12px; margin-bottom:10px;">Îä•Î†•ÏπòÎ•º ÎìúÎûòÍ∑∏ÌïòÏó¨ Ïä¨Î°ØÏóê Î∞∞ÏπòÌïòÏÑ∏Ïöî</div>
            <div class="hand-container" id="hand"></div>
            <div class="slot-container">
                <div class="stat-slot" data-type="move" id="slot-move">Ïù¥Îèô<br><span>-</span></div>
                <div class="stat-slot" data-type="atk" id="slot-atk">Í≥µÍ≤©<br><span>-</span></div>
                <div class="stat-slot" data-type="def" id="slot-def">Î∞©Ïñ¥<br><span>-</span></div>
                <div class="stat-slot" data-type="luck" id="slot-luck">Ïö¥<br><span>-</span></div>
            </div>
            <div style="flex:1"></div>
            <button class="btn-main" onclick="Setup.finish()">Î™®Ìóò ÏãúÏûë</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="hud">
            <div class="top-info">
                <span><span style="color:var(--gold)">Lv.<span id="ui-lv">1</span></span> <span id="ui-turn" style="margin-left:8px;">Turn 1</span></span>
                <span style="color:var(--gold)">üí∞ <span id="ui-gold">0</span></span>
            </div>
            <div class="player-hud-grid">
                <div class="p-panel" id="p1-panel"></div>
                <div class="p-panel" id="p2-panel"></div>
            </div>
            <div class="boss-bar-wrap">
                <div class="boss-hp-fill" id="boss-hp-bar"></div>
                <div class="boss-text" id="boss-hp-text">ÎßàÏôï HP</div>
            </div>
            <div id="doom-timer" style="display:none; color:red; text-align:center; font-weight:bold; font-size:12px; margin-top:2px;">D-DAY: 5</div>
        </div>
        <div id="board-container">
            <div id="grid"></div>
        </div>
        <div id="controls">
            <div class="ctrl-row">
                <button class="c-btn active" id="btn-cam" onclick="Game.toggleCamera()">üé•<br>Í≥†Ï†ï</button>
                <button class="c-btn" id="btn-skill" onclick="Game.onSkillBtnClick()">‚ö°<br>Ïä§ÌÇ¨</button>
                <button class="c-btn" onclick="Game.usePotion()">üß™<br>Î¨ºÏïΩ <span id="ui-pot" style="color:var(--gold)">0</span></button>
                <button class="c-btn" onclick="Shop.open()">üõí<br>ÏÉÅÏ†ê</button>
            </div>
            <button class="roll-btn" id="btn-roll" onclick="Game.roll(false)">Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞</button>
        </div>
    </div>

    <div id="modal-gen" class="modal-overlay">
        <div class="modal-box" id="modal-content"></div>
    </div>
    <div id="modal-shop" class="modal-overlay">
        <div class="modal-box" style="height:70%; max-width:400px;">
            <div class="battle-header">üõí ÎßåÎ¨ºÏÉÅ</div>
            <div id="shop-list" style="flex:1; overflow-y:auto;"></div>
            <button class="btn-main" onclick="Shop.close()" style="margin-bottom:0; padding:10px;">ÎÇòÍ∞ÄÍ∏∞</button>
        </div>
    </div>
</div>

<script>
/* ------------------------------------------------------------------
   [CONFIG] Image Sources
   ------------------------------------------------------------------ */
// ‚ö†Ô∏è Ï§ëÏöî: ÍπÉÌóàÎ∏å Ï£ºÏÜåÏùò 'ÌååÏùº Ïù¥Î¶Ñ ÏïûÎ∂ÄÎ∂Ñ'ÍπåÏßÄÎßå ÎÑ£ÏúºÏÑ∏Ïöî.
const GITHUB_URL = "https://raw.githubusercontent.com/kookul14-dotcom/heartofvauar/blob/main/images/"; 

const IMG_FILE_NAMES = {
    // ÏßÅÏóÖ
    warrior:'warrior.png', knight:'knight.png', rogue:'rogue.png', 
    hunter:'hunter.png', mage:'mage.png', explorer:'explorer.png',
    // Ï†ÑÏßÅ
    berserker:'berserker.png', paladin:'paladin.png',
    guardian:'guardian.png', avenger:'avenger.png',
    assassin:'assassin.png', phantom:'phantom.png',
    sniper:'sniper.png', ranger:'ranger.png',
    archmage:'archmage.png', warlock:'warlock.png',
    alchemist:'alchemist.png', pathfinder:'pathfinder.png',
    // Î™¨Ïä§ÌÑ∞
    slime:'slime.png', goblin:'goblin.png', orc:'orc.png', skeleton:'skeleton.png',
    zombie:'zombie.png', troll:'troll.png', golem:'golem.png', gargoyle:'gargoyle.png',
    lich:'lich.png', dragon:'dragon.png', boss:'boss.png', enemy:'enemy.png',
    // ÌÉÄÏùº
    tile_fire:"tile_fire.png", tile_ice:"tile_ice.png", tile_heal:"tile_heal.png", tile_box:"tile_box.png",
    // ÏïÑÏù¥ÌÖú
    "Í∞ÄÏ£Ω Î∂ÄÏ∏†":"boots_leather.png", "Î∞îÎûåÏùò Ïã†Î∞ú":"boots_wind.png", "Ìó§Î•¥Î©îÏä§ Î∂ÄÏ∏†":"boots_hermes.png",
    "ÎÖπÏä® Í≤Ä":"sword_rusty.png", "Í∏∞ÏÇ¨Ïùò Í≤Ä":"sword_knight.png", "ÎßàÎ≤ï ÏßÄÌå°Ïù¥":"staff_magic.png",
    "ÎØ∏Ïä§Î¶¥ Í≤Ä":"sword_mithril.png",
    "Í∞ÄÏ£Ω Í∞ëÏò∑":"armor_leather.png", "ÌåêÍ∏à Í∞ëÏò∑":"armor_plate.png", "ÏÑ±Í∏∞ÏÇ¨Ïùò Î∞©Ìå®":"shield_paladin.png", "Ïö©Ïùò ÎπÑÎäò":"armor_dragon.png",
    "ÌñâÏö¥ Î∂ÄÏ†Å":"acc_charm.png", "Ìô©Í∏à Î∞òÏßÄ":"acc_goldring.png",
    "ÌöåÎ≥µ Î¨ºÏïΩ":"potion.png", "ÎûúÎç§ Í∞ïÌôî":"upgrade.png"
};

const MON_KEY_MAP = {
    "Ïä¨ÎùºÏûÑ":"slime", "Í≥†Î∏îÎ¶∞":"goblin", "Ïò§ÌÅ¨":"orc", "Ïä§ÏºàÎ†àÌÜ§":"skeleton",
    "Ï¢ÄÎπÑ":"zombie", "Ìä∏Î°§":"troll", "Í≥®Î†ò":"golem", "Í∞ÄÍ≥†Ïùº":"gargoyle", "Î¶¨Ïπò":"lich", "ÎìúÎûòÍ≥§":"dragon"
};

const EMOJI_BACKUP = {
    warrior:'‚öîÔ∏è', knight:'üõ°Ô∏è', rogue:'üó°Ô∏è', hunter:'üèπ', mage:'üîÆ', explorer:'üß≠',
    berserker:'ü©∏', paladin:'‚õ™', guardian:'üè∞', avenger:'üí¢', assassin:'üëª', phantom:'üå´Ô∏è', sniper:'üéØ', ranger:'üçÉ', archmage:'‚ö°', warlock:'üíÄ', alchemist:'‚öóÔ∏è', pathfinder:'üó∫Ô∏è',
    monster:'üëπ', boss:'üëø', enemy:'üë∫',
    tile_fire:'üî•', tile_ice:'‚ùÑÔ∏è', tile_heal:'üíß', tile_box:'üì¶',
    "ÌöåÎ≥µ Î¨ºÏïΩ":'üß™', "ÎûúÎç§ Í∞ïÌôî":'üé≤'
};

const getIcon = (key) => {
    if (GITHUB_URL && GITHUB_URL.length > 10 && IMG_FILE_NAMES[key]) {
        return `<img src="${GITHUB_URL}${IMG_FILE_NAMES[key]}" style="width:100%; height:100%; object-fit:contain;" onerror="this.parentNode.innerHTML='${EMOJI_BACKUP[key]||'‚ùì'}'">`;
    }
    return EMOJI_BACKUP[key] || '‚ùì';
};

/* ------------------------------------------------------------------
   GAME DATA
------------------------------------------------------------------ */
const CLASSES = {
    warrior: {n:'Ï†ÑÏÇ¨', desc:'Ï≤¥Î†•+30, Í≥µÍ≤©+2'}, knight: {n:'Í∏∞ÏÇ¨', desc:'Ï≤¥Î†•+40, Î∞©Ïñ¥+2'},
    rogue: {n:'ÎèÑÏ†Å', desc:'Í≥®Îìú+100, Ïö¥+2'}, hunter: {n:'ÏÇ¨ÎÉ•Íæº', desc:'Í≥µÍ≤©+1, Ïù¥Îèô+1'},
    mage: {n:'ÎßàÎ≤ïÏÇ¨', desc:'Ï≤¥Î†•-20, Í≥µÍ≤©+3'}, explorer: {n:'ÌÉêÌóòÍ∞Ä', desc:'Ïù¥Îèô+2, Î¨ºÏïΩ+2'}
};
const JOBS = {
    warrior: [ {id:'berserker', n:'Í¥ëÏ†ÑÏÇ¨', sn:'ÌîºÏùò Í≤©ÎÖ∏', desc:'HP ÏÜåÎ™®ÌïòÏó¨ Í≥µÍ≤©Î†• 2Î∞∞', type:'passive'}, {id:'paladin', n:'ÏÑ±Í∏∞ÏÇ¨', sn:'Ïã†Ïùò Í∞ÄÌò∏', desc:'Îß§ ÌÑ¥ Ï≤¥Î†• ÌöåÎ≥µ', type:'passive'} ],
    knight: [ {id:'guardian', n:'Í∞ÄÎîîÏñ∏', sn:'Ï≤†Î≤Ω Î∞©Ïñ¥', desc:'Î∞õÎäî ÌîºÌï¥ -3', type:'passive'}, {id:'avenger', n:'Ïñ¥Î≤§Ï†∏', sn:'Î≥µÏàòÏùò ÏπºÎÇ†', desc:'Î∞©Ïñ¥Ïãú Îç∞ÎØ∏ÏßÄ Î∞òÏÇ¨', type:'passive'} ],
    rogue: [ {id:'assassin', n:'Ïñ¥ÏåîÏã†', sn:'Í∏âÏÜå Í∞ÄÍ≤©', desc:'Ïö¥ ÏàòÏπòÎßåÌÅº Í≥µÍ≤©Î†• Ï∂îÍ∞Ä', type:'passive'}, {id:'phantom', n:'Ìå¨ÌÖÄ', sn:'Í∑∏Î¶ºÏûê ÎßùÌÜ†', desc:'30% ÌôïÎ•†Î°ú ÏôÑÏ†Ñ ÌöåÌîº', type:'passive'} ],
    hunter: [ {id:'sniper', n:'Ïä§ÎÇòÏù¥Ìçº', sn:'ÏïΩÏ†ê Ìè¨Ï∞©', desc:'Î∞©Ïñ¥Î†• 50% Í¥ÄÌÜµ', type:'passive'}, {id:'ranger', n:'Î†àÏù∏Ï†Ä', sn:'Î∞îÎûåÏùò ÏÇ¨Í≤©', desc:'Ïù¥ÎèôÍ±∞Î¶¨ÎßåÌÅº Í≥µÍ≤©Î†• Ï∂îÍ∞Ä', type:'passive'} ],
    mage: [ {id:'archmage', n:'ÎåÄÎßàÎ≤ïÏÇ¨', sn:'Î©îÌÖåÏò§', desc:'Í≥†Ï†ï ÌîºÌï¥ 20 (Ïø®ÌÉÄÏûÑ 3)', type:'active', cd:3}, {id:'warlock', n:'ÌùëÎßàÎ≤ïÏÇ¨', sn:'ÏòÅÌòº Ï∞©Ï∑®', desc:'Í≥®Îìú ÏÜåÎ™® Ï∂îÍ∞Ä ÌîºÌï¥', type:'passive'} ],
    explorer: [ {id:'alchemist', n:'Ïó∞Í∏àÏà†ÏÇ¨', sn:'ÎèÖÏÑ± Ìà¨Ï≤ô', desc:'Î¨ºÏïΩ ÏÇ¨Ïö© Ïãú Ï†ÅÏóêÍ≤å ÎèÖÎéÄ', type:'passive'}, {id:'pathfinder', n:'Í∞úÏ≤ôÏûê', sn:'ÏßÄÎ¶ÑÍ∏∏', desc:'Ïù¥Îèô ÏµúÏÜåÍ∞í 4 Î≥¥Ïû•', type:'passive'} ]
};
const ITEMS = [
    {n:"Í∞ÄÏ£Ω Î∂ÄÏ∏†", type:"s", val:1, cost:50, rank:0}, {n:"Î∞îÎûåÏùò Ïã†Î∞ú", type:"s", val:2, cost:100, rank:1}, {n:"Ìó§Î•¥Î©îÏä§ Î∂ÄÏ∏†", type:"s", val:4, cost:220, rank:2},
    {n:"ÎÖπÏä® Í≤Ä", type:"w", val:2, cost:50, rank:0}, {n:"Í∏∞ÏÇ¨Ïùò Í≤Ä", type:"w", val:4, cost:120, rank:1}, {n:"ÎßàÎ≤ï ÏßÄÌå°Ïù¥", type:"w", val:6, cost:200, rank:2}, {n:"ÎØ∏Ïä§Î¶¥ Í≤Ä", type:"w", val:7, cost:250, rank:3},
    {n:"Í∞ÄÏ£Ω Í∞ëÏò∑", type:"a", val:2, cost:50, rank:0}, {n:"ÌåêÍ∏à Í∞ëÏò∑", type:"a", val:4, cost:120, rank:1}, {n:"ÏÑ±Í∏∞ÏÇ¨Ïùò Î∞©Ìå®", type:"a", val:8, cost:300, rank:2}, {n:"Ïö©Ïùò ÎπÑÎäò", type:"a", val:6, cost:200, rank:2},
    {n:"ÌñâÏö¥ Î∂ÄÏ†Å", type:"acc", val:2, cost:80, rank:1}, {n:"Ìô©Í∏à Î∞òÏßÄ", type:"acc", val:4, cost:150, rank:2}
];
const ARTIFACTS = [ {id:'vamp', n:'Ìù°Ìòà', icon:'ü©∏'}, {id:'thorn', n:'Î∞òÏÇ¨', icon:'üåµ'}, {id:'greed', n:'ÌÉêÏöï', icon:'üí∞'}, {id:'glass', n:'Ïú†Î¶¨', icon:'üç∑'}, {id:'boots', n:'Ïã†Î∞ú', icon:'üëû'}, {id:'lucky', n:'ÌñâÏö¥', icon:'üçÄ'} ];
const MONSTERS = ["Ïä¨ÎùºÏûÑ","Í≥†Î∏îÎ¶∞","Ïò§ÌÅ¨","Ïä§ÏºàÎ†àÌÜ§","Ï¢ÄÎπÑ","Ìä∏Î°§","Í≥®Î†ò","Í∞ÄÍ≥†Ïùº","Î¶¨Ïπò","ÎìúÎûòÍ≥§"];
const MON_STATS = [ {mn:1,mx:5},{mn:2,mx:7},{mn:3,mx:9},{mn:3,mx:11},{mn:3,mx:13},{mn:4,mx:15},{mn:4,mx:17},{mn:5,mx:19},{mn:6,mx:22},{mn:8,mx:25} ];

/* ------------------------------------------------------------------
   STATE & UTILS
------------------------------------------------------------------ */
let State = {
    p1: { id:'P1', name:'ÎÇò', job:'warrior', subJob:null, pos:0, hp:100, maxHp:100, gold:0, pot:1, stats:{move:5, atk:5, def:5, luck:2}, bonus:{moveMin:0,moveMax:0,atkMin:0,atkMax:0,defMin:0,defMax:0,luckMin:0,luckMax:0}, equip:{s:null,w:null,a:null,acc:null}, artifacts:[], activeSkill:false, skillCD:0, movedSteps:0 },
    p2: { id:'P2', name:'Ï∂îÍ≤©Ïûê', job:'enemy', pos:0, hp:100, maxHp:100, gold:0, pot:1, stats:{move:5, atk:5, def:5, luck:2}, bonus:{moveMin:0,moveMax:0,atkMin:0,atkMax:0,defMin:0,defMax:0,luckMin:0,luckMax:0}, equip:{s:null,w:null,a:null,acc:null}, isAi:true },
    boss: { hp:100, maxHp:100, mn:8, mx:25 }, monsters: {}, activeSeals: [15, 35],
    turn: 'P1', turnCnt: 1, isMoving: false, cameraLocked: true, 
    cards: [], hand: [], summonCnt: 0, slots: {move:null, atk:null, def:null, luck:null},
    aiMerged: false, limitTurn: 0, frozen: false, extraTurn: false
};

const Utils = {
    rand: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    wait: (ms) => new Promise(r => setTimeout(r, ms)),
    centerCam: (pos) => {
        if(!State.cameraLocked) return;
        const grid = document.getElementById('board-container');
        const tile = document.getElementById(`tile-${pos}`);
        if(tile) grid.scrollTo({ left: tile.offsetLeft - grid.offsetWidth/2 + 30, behavior:'smooth' });
    },
    float: (pos, txt, color='white') => {
        const t = document.getElementById(`tile-${pos}`);
        if(t) { const el = document.createElement('div'); el.className='float-text'; el.style.color=color; el.innerText=txt; t.appendChild(el); setTimeout(()=>el.remove(), 1200); }
    },
    popup: (html) => { const m = document.getElementById('modal-content'); m.innerHTML = html; document.getElementById('modal-gen').style.display = 'flex'; },
    closePopup: () => document.getElementById('modal-gen').style.display = 'none'
};

/* ------------------------------------------------------------------
   LOGIC
------------------------------------------------------------------ */
const Logic = {
    getStats: (p) => {
        const s = p.stats, b = p.bonus, e = p.equip;
        let mv=0, at=0, df=0, lk=0;
        if(e.s) mv+=e.s.val; if(e.w) at+=e.w.val; if(e.a) df+=e.a.val; if(e.acc) lk+=e.acc.val;
        if(p.id==='P1') { if(p.artifacts.some(a=>a.id==='boots')) mv+=1; if(p.artifacts.some(a=>a.id==='lucky')) lk+=2; if(p.artifacts.some(a=>a.id==='glass')) at+=5; }
        let minMove = 1 + b.moveMin; if(p.subJob?.id === 'pathfinder') minMove = Math.max(4, minMove);
        return {
            mvMin: minMove, mvMax: Math.max(1, s.move + b.moveMax + mv),
            atMin: 1 + b.atkMin, atMax: Math.max(1, s.atk + b.atkMax + at),
            dfMin: 1 + b.defMin, dfMax: Math.max(1, s.def + b.defMax + df),
            lkMin: 0 + b.luckMin, lkMax: Math.max(0, s.luck + b.luckMax + lk)
        };
    },
    initBoard: () => {
        const g = document.getElementById('grid'); g.innerHTML='';
        let normalTiles = [];
        for(let i=0; i<50; i++){
            const d=document.createElement('div'); d.className='tile'; d.id=`tile-${i}`;
            let content = `<span class="tile-txt">${i===0?'START':(i===49?'BOSS':i)}</span>`;
            let type = '';
            if(i===0) d.classList.add('tile-start');
            else if(i===49) d.classList.add('tile-end');
            else if(i===25) { d.classList.add('tile-job'); content = `<span class="tile-txt">üëë<br>Ï†ÑÏßÅ</span>`; }
            else if(State.activeSeals.includes(i)) { d.classList.add('tile-seal'); content = `<span class="tile-txt">üíé<br>Î¥âÏù∏</span>`; }
            else {
                const r = Math.random();
                if(r<0.05) type = 'tile_fire'; else if(r<0.10) type = 'tile_ice'; else if(r<0.15) type = 'tile_heal';
                if(type) {
                    d.classList.add(type); const icon = getIcon(type);
                    if(icon.includes('<img')) content = `<div class="tile-img">${icon}</div>`; else content = `<span class="tile-txt">${icon}</span>`;
                } else normalTiles.push(i);
            }
            d.innerHTML = content; g.appendChild(d);
        }
        // [Hidden Box Logic] 50% of Normal Tiles
        Utils.rand(0,0); normalTiles.sort(()=>Math.random()-0.5);
        const boxCount = Math.floor(normalTiles.length * 0.5);
        for(let k=0; k<boxCount; k++) {
            const idx = normalTiles[k]; const t = document.getElementById(`tile-${idx}`);
            t.classList.add('tile_box'); 
            const icon = getIcon('tile_box');
            if(icon.includes('<img')) t.innerHTML = `<div class="tile-img">${icon}</div>`; else t.innerHTML = `<span class="tile-txt">üì¶</span>`;
        }
        // Monsters
        [4,8,12,16,21,26,32,36,41,46].forEach((pos, idx) => {
            const mn = MONSTERS[idx]; State.monsters[pos] = { name: mn, mn: MON_STATS[idx].mn, mx: MON_STATS[idx].mx };
            const m = document.createElement('div'); m.className='obj-wrap';
            m.innerHTML = `<div class="game-img-asset">${getIcon(MON_KEY_MAP[mn])}</div>`; 
            document.getElementById(`tile-${pos}`).appendChild(m);
        });
        const boss = document.createElement('div'); boss.className='obj-wrap';
        boss.innerHTML = `<div class="game-img-asset" style="width:120px; height:120px;">${getIcon('boss')}</div>`;
        document.getElementById('tile-49').appendChild(boss);
        UI.update(); Utils.centerCam(0);
    },
    startTurn: () => {
        State.isMoving = false;
        if(State.limitTurn > 0) {
            State.limitTurn--; const dt = document.getElementById('doom-timer'); dt.style.display='block'; dt.innerText = `BOSS D-DAY: ${State.limitTurn}`;
            if(State.limitTurn <= 0) { alert("Game Over"); location.reload(); return; }
        }
        if(State.aiMerged && State.turn === 'P2') State.turn = 'P1';

        if(State.turn === 'P1') {
            State.turnCnt++;
            document.getElementById('p1-panel').classList.add('active-turn'); document.getElementById('p2-panel').classList.remove('active-turn');
            document.getElementById('btn-roll').disabled = false;
            if(State.p1.skillCD > 0) State.p1.skillCD--;
            if(State.p1.subJob?.id === 'paladin') { State.p1.hp = Math.min(State.p1.maxHp, State.p1.hp+10); Utils.float(State.p1.pos, "+10HP", "lime"); }
            if(State.p1.artifacts.some(a=>a.id==='greed')) State.p1.gold+=10; else State.p1.gold+=5;
            if(State.frozen) { Utils.float(State.p1.pos, "‚ùÑÔ∏èÎèôÏÉÅ", "cyan"); State.frozen=false; }
            document.getElementById('ui-turn').innerText = `Turn ${State.turnCnt}`;
        } else {
            document.getElementById('p1-panel').classList.remove('active-turn'); document.getElementById('p2-panel').classList.add('active-turn');
            document.getElementById('btn-roll').disabled = true;
            State.p2.gold += 10;
            setTimeout(Logic.aiTurn, 800);
        }
        UI.update();
    },
    aiTurn: async () => {
        const p = State.p2; Utils.centerCam(p.pos);
        if(p.hp < p.maxHp * 0.3 && p.pot > 0) { p.pot--; p.hp += 50; Utils.float(p.pos, "Î¨ºÏïΩÏÇ¨Ïö©", "pink"); await Utils.wait(500); } 
        else if(p.gold >= 100) { p.gold -= 100; p.stats.atk++; Utils.float(p.pos, "Í∞ïÌôî", "gold"); await Utils.wait(500); }
        Game.roll(true);
    },
    battle: (atk, def, onEnd, isBoss=false) => {
        const isPvP = !!def;
        const defName = isBoss ? "ÎßàÏôï" : (isPvP ? def.name : State.monsters[atk.pos].name);
        const sAtk = Logic.getStats(atk);
        
        let dMin=0, dMax=0, dLMin=0, dLMax=0, hpCur=0, hpMax=0;
        if(isBoss) { dMin = State.boss.mn; dMax = State.boss.mx; hpCur = State.boss.hp; hpMax = State.boss.maxHp; } 
        else if(isPvP) { const sDef = Logic.getStats(def); dMin = sDef.dfMin; dMax = sDef.dfMax; dLMin=sDef.lkMin; dLMax=sDef.lkMax; hpCur = def.hp; hpMax = def.maxHp; } 
        else { const m = State.monsters[atk.pos]; dMin = m.mn; dMax = m.mx; hpCur = 50; hpMax = 50; }

        const atkIcon = atk.id==='P1' ? (atk.subJob ? getIcon(atk.subJob.id) : getIcon(atk.job)) : getIcon('enemy');
        const defIcon = isBoss ? getIcon('boss') : (isPvP ? (def.id==='P2'?getIcon('enemy'):getIcon(def.job)) : getIcon(MON_KEY_MAP[State.monsters[atk.pos].name]));
        const activeSkill = (atk.id==='P1' && State.p1.activeSkill) ? State.p1.subJob : null;

        const showPrep = () => {
            const skillHtml = activeSkill ? `<div class="skill-notice">‚ö° <b>${activeSkill.sn}</b> Î∞úÎèô!</div>` : '';
            Utils.popup(`
                <div class="battle-header">${isBoss?'‚ò†Ô∏è Î≥¥Ïä§Ï†Ñ':(isPvP?'‚öîÔ∏è Í≤∞Ìà¨':'üëπ Ï†ÑÌà¨')}</div>
                <div class="battle-stage">
                    <div class="fighter-card">
                        <div class="f-img-box">${atkIcon}</div><div class="f-name">${atk.name}</div>
                        <div class="f-hp-bar"><div class="f-hp-fill" style="width:${(atk.hp/atk.maxHp)*100}%; background:var(--p1-color);"></div></div>
                        <div class="stat-compare"><span class="sc-label">ATK</span> <span class="sc-val">${sAtk.atMin}~${sAtk.atMax}</span></div>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="fighter-card">
                        <div class="f-img-box" style="border-color:#da3633">${defIcon}</div><div class="f-name">${defName}</div>
                        <div class="f-hp-bar"><div class="f-hp-fill" style="width:${(hpCur/hpMax)*100}%; background:var(--p2-color);"></div></div>
                        <div class="stat-compare"><span class="sc-val">${dMin}~${dMax}</span> <span class="sc-label" style="color:#da3633">DEF</span></div>
                    </div>
                    ${skillHtml}
                </div>
                <button class="btn-main" id="btn-fight-start">‚öîÔ∏è Ï†ÑÌà¨ ÏãúÏûë</button>
            `);
            if(atk.isAi) setTimeout(runBattle, 1500); else document.getElementById('btn-fight-start').onclick = runBattle;
        };

        const runBattle = () => {
            let log = [];
            let rawAtk = Utils.rand(sAtk.atMin, sAtk.atMax);
            let luckAtk = Utils.rand(sAtk.lkMin, sAtk.lkMax);
            if(atk.id==='P1') {
                if(atk.subJob?.id === 'assassin') luckAtk *= 2; 
                if(atk.subJob?.id === 'ranger') rawAtk += atk.movedSteps;
                if(atk.subJob?.id === 'berserker' && atk.hp > 25) { atk.hp-=25; rawAtk*=2; log.push("ÌîºÏùò Í≤©ÎÖ∏ (HP-25, Í≥µ2Î∞∞)"); }
                if(activeSkill?.id === 'archmage') { rawAtk = 20; luckAtk = 0; log.push("Î©îÌÖåÏò§ Ïä§Ìä∏ÎùºÏù¥ÌÅ¨!"); }
                if(atk.subJob?.id === 'warlock' && atk.gold >= 50) { atk.gold-=50; rawAtk+=15; log.push("ÏòÅÌòº Ï∞©Ï∑® (+15ÎéÄ)"); }
            }
            let totalAtk = rawAtk + luckAtk;
            let rawDef = Utils.rand(dMin, dMax);
            let luckDef = Utils.rand(dLMin, dLMax);
            let totalDef = rawDef + luckDef;
            if(def && def.id==='P1' && def.artifacts.some(a=>a.id==='glass')) totalDef -= 5;
            if(atk.id==='P1' && atk.subJob?.id === 'sniper') { totalDef = Math.floor(totalDef/2); log.push("ÏïΩÏ†ê Ìè¨Ï∞© (Í¥ÄÌÜµ)"); }

            let win = totalAtk >= totalDef;
            let dmg = 0, selfDmg = 0;
            if(!win && def && def.id==='P1' && def.subJob?.id==='phantom' && Math.random()<0.3) { log.push("Í∑∏Î¶ºÏûê ÎßùÌÜ†: ÌöåÌîº!"); totalAtk=0; }

            if(win) {
                dmg = isPvP || isBoss ? Math.max(1, totalAtk - Math.floor(totalDef/2)) : 100;
                selfDmg = (isBoss || isPvP) ? Math.floor(totalDef * 0.2) : 0;
                if(atk.id==='P1' && atk.subJob?.id==='guardian') selfDmg = Math.max(0, selfDmg-3);
                log.push(`<span class="log-hlt">ÏäπÎ¶¨!</span> Í≥µÍ≤© ${totalAtk} vs Î∞©Ïñ¥ ${totalDef}`);
                log.push(`Ï†ÅÏóêÍ≤å <span class="log-dmg">${dmg}</span> ÌîºÌï¥!`);
                if(isPvP) { State.extraTurn = true; log.push("‚ö° Ïó∞ÏÜç ÌñâÎèô Í∏∞Ìöå ÌöçÎìù!"); }
            } else {
                selfDmg = Math.max(1, totalDef - totalAtk);
                if(def && def.id==='P1' && def.subJob?.id==='avenger') {
                    let ref = Math.floor(totalDef*0.5); atk.hp-=ref; log.push(`Î≥µÏàòÏùò ÏπºÎÇ†: ${ref} Î∞òÏÇ¨!`);
                }
                if(def && def.id==='P1' && def.artifacts.some(a=>a.id==='thorn')) { atk.hp-=5; log.push("Í∞ÄÏãúÍ∞ëÏò∑ Î∞òÏÇ¨ -5HP"); }
                log.push(`<span style="color:#da3633">Ìå®Î∞∞..</span> Î∞òÎèô ${selfDmg} ÌîºÌï¥`);
                if(isPvP) { State.extraTurn = true; log.push("‚ö° Ï†ÅÏùò Ïó∞ÏÜç ÌñâÎèô!"); }
            }

            if(isBoss) State.boss.hp = Math.max(0, State.boss.hp - dmg); else if(isPvP) def.hp = Math.max(0, def.hp - dmg);
            atk.hp = Math.max(0, atk.hp - selfDmg);
            if(atk.id==='P1') State.p1.activeSkill = false;
            if(atk.id==='P1' && atk.artifacts.some(a=>a.id==='vamp')) { atk.hp+=5; log.push("Ìù°Ìòà +5HP"); }

            Utils.popup(`
                <div class="battle-header">${win ? '<span style="color:lime">VICTORY</span>' : '<span style="color:red">DEFEAT</span>'}</div>
                <div class="battle-stage">
                    <div class="fighter-card">
                        <div class="f-img-box">${atkIcon}</div><div class="f-name">${atk.name}</div>
                        <div class="f-hp-bar"><div class="f-hp-fill" style="width:${(atk.hp/atk.maxHp)*100}%; background:var(--p1-color);"></div></div>
                        <div class="f-name">${atk.hp} / ${atk.maxHp}</div>
                    </div>
                    <div class="fighter-card">
                        <div class="f-img-box" style="border-color:#da3633">${defIcon}</div><div class="f-hp-bar"><div class="f-hp-fill" style="width:${(isBoss?State.boss.hp : (isPvP?def.hp:0)) / (isBoss?State.boss.maxHp:(isPvP?def.maxHp:100))*100}%; background:var(--p2-color);"></div></div>
                        <div class="f-name">${isBoss?State.boss.hp:(isPvP?def.hp:'DEAD')}</div>
                    </div>
                </div>
                <div class="battle-log-area">${log.map(l => `<div class="log-line">${l}</div>`).join('')}</div>
                <button class="btn-main" id="btn-close-battle">ÌôïÏù∏</button>
            `);
            if(dmg>0) Utils.float(isBoss?49:(isPvP?def.pos:atk.pos), `-${dmg}`, "red");
            if(selfDmg>0) Utils.float(atk.pos, `-${selfDmg}`, "red");
            if(win && !isBoss && !isPvP) { delete State.monsters[atk.pos]; document.getElementById(`tile-${atk.pos}`).querySelector('.obj-wrap').remove(); atk.gold += Utils.rand(30,60); }
            UI.update();
            const closeAct = () => { 
                Utils.closePopup(); 
                if(State.extraTurn) {
                    State.extraTurn = false; Utils.float(atk.pos, "Ïó∞ÏÜç ÌñâÎèô!", "lime");
                    if(atk.isAi) setTimeout(Logic.aiTurn, 1000); else document.getElementById('btn-roll').disabled = false;
                } else { onEnd(); }
            };
            if(atk.isAi) setTimeout(closeAct, 2000); else document.getElementById('btn-close-battle').onclick = closeAct;
        };
        showPrep();
    },
    handleEvent: (p) => {
        return new Promise(resolve => {
            const t = document.getElementById(`tile-${p.pos}`);
            if(t.classList.contains('tile_fire')) { p.hp -= 10; Utils.float(p.pos, "-10HP", "orange"); resolve(); }
            else if(t.classList.contains('tile_ice')) { Utils.float(p.pos, "ÎèôÏÉÅ", "cyan"); if(p.id==='P1') State.frozen=true; resolve(); }
            else if(t.classList.contains('tile_heal')) { p.hp = Math.min(p.maxHp, p.hp+20); Utils.float(p.pos, "+20HP", "lime"); resolve(); }
            // [HIDDEN BOX LOGIC]
            else if(t.classList.contains('tile_box') && p.id==='P1') {
                Utils.popup(`
                    <h3 style="color:var(--gold); text-align:center;">Ïà®Í≤®ÏßÑ ÏÉÅÏûê Î∞úÍ≤¨!</h3>
                    <div style="text-align:center; color:#ddd; margin-bottom:10px;">ÏÉÅÏûêÎ•º Ïó¥Ïñ¥Î≥¥ÏãúÍ≤†ÏäµÎãàÍπå?</div>
                    <button class="choice-btn" id="box-open">Ïó∞Îã§</button><button class="choice-btn" id="box-pass">ÏßÄÎÇòÍ∞ÑÎã§</button>
                `);
                document.getElementById('box-open').onclick = () => {
                    const r = Math.random() * 100;
                    let msg = "";
                    if(r < 30) { // Equip
                        let rank=0; const r2=Math.random()*100;
                        if(r2<50) rank=0; else if(r2<80) rank=1; else if(r2<95) rank=2; else rank=3; // Common, Uncommon, Rare, Legend (NEW)
                        const pool = ITEMS.filter(i=>i.rank===rank);
                        const it = pool[Utils.rand(0, pool.length-1)] || ITEMS[0];
                        p.equip[it.type] = it; msg = `<span style="color:lime">${it.n} ÌöçÎìù!</span>`;
                    } else if (r < 60) { // Gold
                        const g = Utils.rand(20,100); p.gold+=g; msg = `<span style="color:gold">+${g} Í≥®Îìú</span>`;
                    } else if (r < 90) { // Stat
                        const stat = ['move','atk','def','luck'][Utils.rand(0,3)];
                        const val = [-1,1,2][Utils.rand(0,2)];
                        p.stats[stat] = Math.max(0, p.stats[stat]+val);
                        msg = `Îä•Î†•Ïπò ${stat.toUpperCase()} ${val>0?'+':''}${val}`;
                    } else if (r < 95) { // Bomb
                        const dmg = Utils.rand(10,20); p.hp-=dmg; msg = `<span style="color:red">Ìè≠ÌÉÑ! -${dmg}HP</span>`;
                    } else { // Theft
                        const loss = Utils.rand(10,50); p.gold = Math.max(0, p.gold-loss); msg = `<span style="color:gray">ÎèÑÎÇú! -${loss}G</span>`;
                    }
                    Utils.popup(`<div style="text-align:center; font-size:18px; padding:20px;">${msg}</div>`);
                    t.classList.remove('tile_box'); 
                    // Update visual to show opened
                    const icon = getIcon('tile_box'); 
                    if(!icon.includes('<img')) t.innerHTML = `<span class="tile-txt" style="color:#555">üì≠</span>`; // Empty
                    setTimeout(() => { Utils.closePopup(); resolve(); }, 1200);
                };
                document.getElementById('box-pass').onclick = () => { Utils.closePopup(); resolve(); };
            }
            else if(p.pos === 25 && p.id === 'P1' && !p.subJob) {
                const choices = JOBS[p.job].map(j => `<button class="choice-btn" onclick="Logic.jobChange('${j.id}')"><b>${j.n}</b><br><span style="font-size:10px">${j.desc}</span></button>`).join('');
                Utils.popup(`<h3 style="color:var(--gold); text-align:center;">Ï†ÑÏßÅÏÜå</h3>${choices}`);
            }
            else if(State.activeSeals.includes(p.pos)) {
                State.activeSeals = State.activeSeals.filter(s => s!==p.pos); t.classList.remove('tile-seal'); t.innerHTML = `<span class="tile-txt">${p.pos}</span>`;
                if(p.id==='P1') {
                    State.boss.hp = Math.floor(State.boss.hp*0.8);
                    const art = ARTIFACTS[Utils.rand(0, ARTIFACTS.length-1)]; p.artifacts.push(art);
                    Utils.popup(`<div style="text-align:center;">Î¥âÏù∏ Ìï¥Ï†ú!<br>Î≥¥Ïä§ Ï≤¥Î†• Í∞êÏÜå & <span style="color:var(--gold)">${art.n}</span> ÌöçÎìù</div>`);
                    setTimeout(() => { Utils.closePopup(); resolve(); }, 1500);
                } else { State.boss.hp += 20; Utils.float(p.pos, "Î¥âÏù∏ÌååÍ¥¥(Î≥¥Ïä§Í∞ïÌôî)", "red"); resolve(); }
            } else resolve();
        });
    },
    jobChange: (jid) => {
        State.p1.subJob = JOBS[State.p1.job].find(j=>j.id===jid);
        State.p1.maxHp += 20; State.p1.hp = State.p1.maxHp; State.p1.bonus.atkMax += 2; State.p1.bonus.defMax += 2;
        Utils.closePopup(); Logic.endTurn();
    },
    endTurn: () => {
        State.turn = State.turn==='P1'?'P2':'P1'; Logic.startTurn();
    }
};

const UI = {
    update: () => {
        document.querySelectorAll('.pawn').forEach(e=>e.remove());
        const makePawn = (p, cls, icon) => {
            const t = document.getElementById(`tile-${p.pos}`);
            if(t) { const el = document.createElement('div'); el.className=`pawn ${cls}`; el.innerHTML = `<div class="game-img-asset">${icon}</div>`; t.appendChild(el); }
        };
        const p1Icon = State.p1.subJob ? getIcon(State.p1.subJob.id) : getIcon(State.p1.job);
        makePawn(State.p1, 'p1', p1Icon); if(!State.aiMerged) makePawn(State.p2, 'p2', getIcon('enemy'));

        const renStats = (p, elId) => {
            const el = document.getElementById(elId); const s = Logic.getStats(p);
            const icon = p.id === 'P1' ? p1Icon : getIcon('enemy');
            const jobName = p.id === 'P1' ? (p.subJob ? p.subJob.n : CLASSES[p.job].n) : 'Ï∂îÍ≤©Ïûê';
            let artsHtml = ''; if(p.id==='P1') artsHtml = p.artifacts.map(a => `<div class="art-slot">${a.icon}</div>`).join('');
            el.innerHTML = `
                <div class="char-header"><div class="char-icon">${icon}</div><div class="char-info"><div class="char-name">${p.name}</div><div class="char-job">${jobName}</div></div></div>
                <div class="hp-bar-sm"><div class="hp-fill-sm" style="width:${(p.hp/p.maxHp)*100}%; background:${p.id==='P1'?'var(--p1-color)':'var(--p2-color)'}"></div></div>
                <div class="stats-row"><div class="s-item">ü¶∂<span class="s-val">${s.mvMin}~${s.mvMax}</span></div><div class="s-item">‚öîÔ∏è<span class="s-val">${s.atMin}~${s.atMax}</span></div><div class="s-item">üõ°Ô∏è<span class="s-val">${s.dfMin}~${s.dfMax}</span></div><div class="s-item">üçÄ<span class="s-val">${s.lkMin}~${s.lkMax}</span></div></div>
                <div class="equip-tray"><div class="eq-slot ${p.equip.s?'filled':''}">${p.equip.s?getIcon(p.equip.s.n):'üëü'}</div><div class="eq-slot ${p.equip.w?'filled':''}">${p.equip.w?getIcon(p.equip.w.n):'‚öîÔ∏è'}</div><div class="eq-slot ${p.equip.a?'filled':''}">${p.equip.a?getIcon(p.equip.a.n):'üõ°Ô∏è'}</div><div class="eq-slot ${p.equip.acc?'filled':''}">${p.equip.acc?getIcon(p.equip.acc.n):'üíç'}</div>${artsHtml}</div>
            `;
        };
        renStats(State.p1, 'p1-panel'); renStats(State.p2, 'p2-panel');
        document.getElementById('ui-lv').innerText = "1"; document.getElementById('ui-gold').innerText = State.p1.gold; document.getElementById('ui-pot').innerText = State.p1.pot;
        document.getElementById('boss-hp-bar').style.width = `${(State.boss.hp/State.boss.maxHp)*100}%`; document.getElementById('boss-hp-text').innerText = `ÎßàÏôï HP: ${State.boss.hp}`;
    }
};

const Setup = {
    init: () => {
        const list = document.getElementById('class-list');
        for(let k in CLASSES) {
            const c = CLASSES[k];
            const d = document.createElement('div'); d.className='class-card';
            d.innerHTML = `<div style="font-size:30px;">${getIcon(k)}</div><div style="font-weight:bold; color:white;">${c.n}</div><div style="font-size:11px; color:#888;">${c.desc}</div>`;
            d.onclick = () => {
                State.p1.job = k;
                if(k==='warrior') State.p1.maxHp+=30; else if(k==='knight') State.p1.maxHp+=40; else if(k==='rogue') State.p1.gold+=100; else if(k==='hunter') { State.p1.bonus.atkMax++; State.p1.bonus.moveMax++; } else if(k==='mage') { State.p1.maxHp-=20; State.p1.bonus.atkMax+=3; } else if(k==='explorer') { State.p1.bonus.moveMax+=2; State.p1.pot+=2; }
                State.p1.hp = State.p1.maxHp;
                document.getElementById('screen-class').style.display='none'; document.getElementById('screen-setup').style.display='flex';
                for(let i=0; i<40; i++) {
                     let r = Math.random(), rank='common', color='var(--common)';
                     let stat = {mv:[1,3], at:[1,4], df:[1,4], lk:[0,1]};
                     if(r<0.1) { rank='legend'; color='var(--legend)'; stat={mv:[3,6],at:[8,12],df:[5,8],lk:[3,5]}; }
                     else if(r<0.3) { rank='rare'; color='var(--rare)'; stat={mv:[2,5],at:[5,8],df:[3,6],lk:[1,3]}; }
                     State.cards.push({ id:i, rank, color, mv:Utils.rand(stat.mv[0], stat.mv[1]), at:Utils.rand(stat.at[0], stat.at[1]), df:Utils.rand(stat.df[0], stat.df[1]), lk:Utils.rand(stat.lk[0], stat.lk[1]) });
                }
            };
            list.appendChild(d);
        }
    },
    summon: () => {
        if(State.summonCnt>=4) return;
        const c = State.cards.splice(Utils.rand(0, State.cards.length-1), 1)[0]; State.hand.push(c);
        const el = document.createElement('div'); el.className = `merc-card ${c.rank}`;
        const maxVal = Math.max(c.mv, c.at, c.df, c.lk);
        const style = (val) => val === maxVal ? 'stat-max' : '';
        el.innerHTML = `
            <div class="merc-title" style="color:${c.color};">Ïö©Î≥ë ${State.summonCnt+1} (${c.rank.toUpperCase()})</div>
            <div class="merc-stats">
                <div class="stat-box">ü¶∂ <span class="stat-val ${style(c.mv)}">${c.mv}</span></div>
                <div class="stat-box">‚öîÔ∏è <span class="stat-val ${style(c.at)}">${c.at}</span></div>
                <div class="stat-box">üõ°Ô∏è <span class="stat-val ${style(c.df)}">${c.df}</span></div>
                <div class="stat-box">üçÄ <span class="stat-val ${style(c.lk)}">${c.lk}</span></div>
            </div>
        `;
        document.getElementById('gacha-view').appendChild(el);
        State.summonCnt++; document.getElementById('btn-summon').innerText = `ÏÜåÌôò (${State.summonCnt}/4)`;
        if(State.summonCnt===4) { setTimeout(() => { document.getElementById('phase-gacha').style.display='none'; document.getElementById('phase-place').style.display='flex'; Setup.renderHand(); }, 800); }
    },
    renderHand: () => {
        const con = document.getElementById('hand'); con.innerHTML = '';
        State.hand.forEach(c => {
            const d = document.createElement('div'); d.className='dragger'; d.id=`card-${c.id}`; d.draggable=true; d.style.borderColor = c.color;
            const maxVal = Math.max(c.mv, c.at, c.df, c.lk);
            const style = (val) => val === maxVal ? 'color:var(--highlight); font-weight:bold; transform:scale(1.2);' : '';
            d.innerHTML = `<div style="color:${c.color}; font-weight:bold; font-size:10px;">${c.rank.toUpperCase()}</div><div class="d-stats"><div style="${style(c.mv)}">ü¶∂${c.mv}</div><div style="${style(c.at)}">‚öîÔ∏è${c.at}</div><div style="${style(c.df)}">üõ°Ô∏è${c.df}</div><div style="${style(c.lk)}">üçÄ${c.lk}</div></div>`;
            d.ondragstart = e => e.dataTransfer.setData('cid', c.id);
            d.ontouchstart = e => { window.touchCard = c; document.querySelectorAll('.dragger').forEach(x=>x.style.opacity=1); d.style.opacity=0.5; };
            con.appendChild(d);
        });
        document.querySelectorAll('.stat-slot').forEach(s => {
            s.ondragover = e => e.preventDefault(); s.ondrop = e => Setup.place(s, e.dataTransfer.getData('cid')); s.onclick = () => { if(window.touchCard) Setup.place(s, window.touchCard.id); };
        });
    },
    place: (slot, cid) => {
        const c = State.hand.find(x => x.id == cid); const type = slot.dataset.type;
        for(let k in State.slots) if(State.slots[k]===c) State.slots[k]=null;
        State.slots[type] = c; window.touchCard = null; Setup.updateSlots();
    },
    updateSlots: () => {
        document.querySelectorAll('.dragger').forEach(d=>d.classList.remove('placed'));
        for(let k in State.slots) {
            const c = State.slots[k]; const el = document.getElementById(`slot-${k}`);
            el.className = 'stat-slot'; el.innerHTML = `<div class="slot-label">${{move:'Ïù¥Îèô',atk:'Í≥µÍ≤©',def:'Î∞©Ïñ¥',luck:'Ïö¥'}[k]}</div><div class="slot-val">-</div>`;
            if(c) { document.getElementById(`card-${c.id}`).classList.add('placed'); el.classList.add('filled'); el.style.borderColor=c.color; const val = k==='move'?c.mv : (k==='atk'?c.at : (k==='def'?c.df : c.lk)); el.innerHTML = `<div class="slot-label" style="color:${c.color}">${c.rank}</div><div class="slot-val" style="color:${c.color}; font-size:24px;">${val}</div>`; }
        }
    },
    finish: () => {
        if(!Object.values(State.slots).every(x=>x)) return alert("Î™®Îì† Ïä¨Î°ØÏùÑ Ï±ÑÏõåÏ£ºÏÑ∏Ïöî.");
        const s = State.slots; State.p1.stats = { move:s.move.mv, atk:s.atk.at, def:s.def.df, luck:s.luck.lk };
        let pool = []; for(let i=0; i<4; i++) pool.push(State.cards[Utils.rand(0, State.cards.length-1)]);
        State.p2.stats = { move:pool[0].mv, atk:pool[1].at, def:pool[2].df, luck:pool[3].lk };
        document.getElementById('screen-setup').style.display='none'; document.getElementById('screen-game').style.display='flex';
        Logic.initBoard(); Logic.startTurn();
    }
};

const Game = {
    toggleCamera: () => {
        State.cameraLocked = !State.cameraLocked;
        const b = document.getElementById('btn-cam');
        if(State.cameraLocked) { b.classList.add('active'); b.innerHTML='üé•<br>Í≥†Ï†ï'; Utils.centerCam(State.turn==='P1'?State.p1.pos:State.p2.pos); }
        else { b.classList.remove('active'); b.innerHTML='üîì<br>ÏûêÏú†'; }
    },
    roll: async (isAi) => {
        if(State.isMoving) return;
        State.isMoving = true;
        const p = isAi ? State.p2 : State.p1;
        
        // Move Step
        const s = Logic.getStats(p);
        const steps = Utils.rand(s.mvMin, s.mvMax);
        Utils.float(p.pos, `üé≤ ${steps}`, "cyan");
        if(p.subJob?.id==='ranger') p.movedSteps = steps;

        for(let i=0; i<steps; i++){
            if(p.pos >= 49) break;
            p.pos++; UI.update(); Utils.centerCam(p.pos);
            await Utils.wait(200);
            
            const enemy = isAi ? State.p1 : State.p2;
            if(p.pos === enemy.pos && p.pos!==0 && p.pos!==49 && !State.aiMerged) { return Logic.battle(p, enemy, Logic.endTurn); }
            if(State.monsters[p.pos]) { return Logic.battle(p, null, Logic.endTurn); }
            if(!isAi && p.pos!==49 && p.pos!==25) { await Logic.handleEvent(p); }
        }
        
        if(p.pos === 49) {
            if(isAi) { State.aiMerged = true; State.boss.hp*=2; State.boss.maxHp*=2; State.limitTurn=5; Utils.float(49, "Î≥¥Ïä§Ìï©Ï≤¥!", "red"); alert("Ï∂îÍ≤©ÏûêÍ∞Ä ÎßàÏôïÍ≥º Ìï©Ï≤¥ÌñàÏäµÎãàÎã§! 5ÌÑ¥ ÎÇ¥Ïóê Ï≤òÏπòÌïòÏÑ∏Ïöî!"); Logic.endTurn(); } 
            else { return Logic.battle(p, null, Logic.endTurn, true); }
        } else if(p.pos===25 && !isAi && !p.subJob) { Logic.handleEvent(p); } 
        else { Logic.endTurn(); }
    },
    usePotion: () => {
        if(State.turn!=='P1' || State.p1.pot<=0 || State.isMoving) return;
        State.p1.pot--; State.p1.hp = Math.min(State.p1.maxHp, State.p1.hp+50);
        if(State.p1.subJob?.id==='alchemist') { State.boss.hp-=10; Utils.float(49,"-10(ÎèÖ)","purple"); }
        Utils.float(State.p1.pos, "+50 HP", "pink"); UI.update();
    },
    onSkillBtnClick: () => {
        if(State.p1.subJob && State.p1.subJob.type === 'active') {
            if(State.p1.skillCD > 0) return alert(`Ïø®ÌÉÄÏûÑ: ${State.p1.skillCD}ÌÑ¥`);
            if(confirm(`${State.p1.subJob.sn} ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) { State.p1.activeSkill = true; State.p1.skillCD = State.p1.subJob.cd; Utils.float(State.p1.pos, "‚ö°Ïä§ÌÇ¨ Ïû•Ï†Ñ", "yellow"); }
        } else { alert("Ïï°Ìã∞Î∏å Ïä§ÌÇ¨Ïù¥ ÏóÜÏäµÎãàÎã§ (Ï†ÑÏßÅ ÌïÑÏöî)"); }
    }
};

const Shop = {
    open: () => {
        if(State.turn!=='P1') return;
        const list = document.getElementById('shop-list'); list.innerHTML='';
        const addShopItem = (name, type, val, cost, iconKey) => {
            const d = document.createElement('div'); d.className='shop-item';
            d.innerHTML = `
                <div class="shop-img-box">${getIcon(name)}</div>
                <div class="shop-info">
                    <div style="color:white; font-size:13px; font-weight:bold;">${name}</div>
                    <div style="color:#888; font-size:11px;">${type}</div>
                </div>
                <button class="btn-main" style="width:60px; padding:5px; font-size:12px; margin:0;" onclick="Shop.buy('${name}')">${cost}</button>
            `;
            list.appendChild(d);
        };
        addShopItem("ÌöåÎ≥µ Î¨ºÏïΩ", "HP +50", 0, 50, "potion");
        addShopItem("ÎûúÎç§ Í∞ïÌôî", "Ïä§ÌÉØ +1", 0, 100, "upgrade");
        ITEMS.forEach(it => addShopItem(it.n, it.type.toUpperCase()+` +${it.val}`, it.val, it.cost, it.n));
        document.getElementById('modal-shop').style.display='flex';
    },
    close: () => document.getElementById('modal-shop').style.display='none',
    buy: (n) => {
        const cost = n==="ÌöåÎ≥µ Î¨ºÏïΩ"?50 : (n==="ÎûúÎç§ Í∞ïÌôî"?100 : ITEMS.find(x=>x.n===n).cost);
        if(State.p1.gold >= cost) {
            State.p1.gold -= cost;
            if(n==="ÌöåÎ≥µ Î¨ºÏïΩ") { State.p1.pot++; Utils.float(State.p1.pos, "+Î¨ºÏïΩ", "pink"); }
            else if(n==="ÎûúÎç§ Í∞ïÌôî") { State.p1.stats[['move','atk','def','luck'][Utils.rand(0,3)]]++; Utils.float(State.p1.pos, "Í∞ïÌôîÏÑ±Í≥µ", "lime"); }
            else { const it = ITEMS.find(x=>x.n===n); State.p1.equip[it.type] = it; Utils.float(State.p1.pos, "Ïû•Ï∞©ÏôÑÎ£å", "cyan"); }
            UI.update();
        } else alert("Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.");
    }
};

Setup.init();
</script>
</body>
</html>
