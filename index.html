<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPG Board: Final Fixed</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Do+Hyeon&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
<style>
    /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
    :root {
        --bg-color: #121212; --panel-bg: #1e1e1e; --text-color: #e0e0e0;
        --p1-color: #4CAF50; --p2-color: #E91E63; --gold: #FFD700;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    /* ê¸°ì¡´ height: 100vh ëŒ€ì‹  ì•„ë˜ ì½”ë“œë¥¼ ì‚¬ìš© */
    height: 100dvh; /* dynamic vh: ì£¼ì†Œì°½ì„ ì œì™¸í•œ ì‹¤ì œ ë†’ì´ */
    margin: 0;
    overflow: hidden;
    display: flex;
    justify-content: center;
    background-color: #000;
}

#game-wrapper {
    width: 100%;
    max-width: 800px;
    height: 100dvh; /* ì—¬ê¸°ë„ ë™ì¼í•˜ê²Œ ìˆ˜ì • */
    position: relative;
    display: flex;
    flex-direction: column;
}

    /* Animations */
    @keyframes flash-red { 0%{box-shadow:inset 0 0 0 0 red;} 50%{box-shadow:inset 0 0 50px 20px rgba(255,0,0,0.5);} 100%{box-shadow:inset 0 0 0 0 red;} }
    .flash-damage { animation: flash-red 0.3s linear; }
    
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }
    .shake-anim { animation: shake 0.3s; }
    
    @keyframes floatUp { 0%{transform:translateY(0) scale(1);opacity:1} 100%{transform:translateY(-50px) scale(1.2);opacity:0} }
    .float-text {
        position: absolute; font-weight: bold; font-size: 16px; 
        text-shadow: 2px 2px 0 #000;
        animation: floatUp 1.5s forwards; z-index: 999; pointer-events: none; width: 150px; text-align: center;
        left: 50%; transform: translateX(-50%);
    }
    
    @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.7);} 70% {box-shadow: 0 0 0 10px rgba(0, 255, 255, 0);} 100% {box-shadow: 0 0 0 0 rgba(0, 255, 255, 0);} }
    @keyframes bar-flash { 0% {filter: brightness(2);} 100% {filter: brightness(1);} }
    @keyframes bar-shake { 0% {transform: translateX(0);} 25% {transform: translateX(-2px);} 50% {transform: translateX(2px);} 100% {transform: translateX(0);} }
    @keyframes boss-pulse { 0% {box-shadow: inset 0 0 20px #500;} 50% {box-shadow: inset 0 0 60px #f00;} 100% {box-shadow: inset 0 0 20px #500;} }

    /* Battle Animations */
    @keyframes attack-thrust { 0% {transform: scale(1) translateX(0);} 50% {transform: scale(1.1) translateX(20px);} 100% {transform: scale(1) translateX(0);} }
    @keyframes attack-thrust-enemy { 0% {transform: scaleX(-1) scale(1) translateX(0);} 50% {transform: scaleX(-1) scale(1.1) translateX(20px);} 100% {transform: scaleX(-1) scale(1) translateX(0);} }
    .atk-anim-p1 { animation: attack-thrust 0.3s ease-in-out; }
    .atk-anim-enemy { animation: attack-thrust-enemy 0.3s ease-in-out; }
    .hit-anim { animation: shake 0.4s, bar-flash 0.4s; }

    /* UI Structure */
    .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 10; display: none; flex-direction: column; }
    .active-screen { display: flex; }
    .font-header { font-family: 'Do Hyeon', sans-serif; }
    
    button { cursor: pointer; border: none; outline: none; transition: 0.2s; }
    button:active { transform: scale(0.96); }
    .btn-main {
        width: 90%; padding: 15px; font-size: 20px; border-radius: 8px;
        background: linear-gradient(135deg, #FF9800, #FF5722);
        color: white; font-family: 'Do Hyeon'; margin: 10px auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .btn-main:disabled { background: #555; color: #888; cursor: not-allowed; }

    /* HUD */
    #screen-game { display: none; flex-direction: column; }
    #hud { 
        position: absolute; top: 0; left: 0; width: 100%; height: 260px; 
        background: rgba(0, 0, 0, 0.3); 
        backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
        display: flex; flex-direction: column; padding: 5px; 
        z-index: 50; 
    }

    .top-bar { display: flex; justify-content: space-between; padding: 5px 10px; font-size: 14px; }

    .p-stats-wrapper { display: flex; flex-direction: row; gap: 4px; height: 100%; }
    .p-panel { 
        flex: 1; background: rgba(0, 0, 0, 0.5); 
        border-radius: 5px; padding: 6px; 
        display: flex; flex-direction: column; justify-content: space-around; 
        font-size: 11px; position: relative; 
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .p-panel.active-turn { 
        border: 2px solid rgba(255, 255, 255, 0.8); 
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1); 
        background: rgba(50, 50, 50, 0.6);
    }    
    .stat-line { display: flex; justify-content: space-between; color: #bbb; margin-bottom: 4px; }
    .hp-wrap { width: 100%; height: 12px; background: #333; margin-bottom: 6px; border-radius: 6px; overflow: hidden; position: relative; }
    .hp-fill { height: 100%; width: 100%; transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .p1-hp { background: var(--p1-color); } 
    .p2-hp { background: var(--p2-color); }
    
    .equip-row { display: flex; gap: 3px; margin-top: 4px; justify-content: center; height: auto; }
    .equip-slot { width: 30px; height: 30px; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 15px; color:#555; overflow: hidden; }
    .equip-slot.filled { border-color: gold; background: #2a2a2a; color: white; }
    .art-row { display: flex; gap: 3px; margin-top: 4px; justify-content: center; min-height: 28px; flex-wrap: wrap; }
    .art-slot { width: 30px; height: 30px; font-size: 15px; cursor: help; filter: drop-shadow(0 0 2px gold); display: flex; align-items: center; justify-content: center; }

    .boss-bar-wrap { height: 35px; background: #300; border-top: 2px solid red; position: relative; display: flex; align-items: center; justify-content: center; }
    .boss-hp-fill { position: absolute; left: 0; top: 0; height: 100%; background: #d32f2f; width: 100%; transition: width 0.3s; }
    .boss-text { font-size: 16px; color: white; font-weight: bold; text-shadow: 1px 1px 2px black; z-index: 5; }

    #board-container { flex: 1; overflow-x: auto; overflow-y: hidden; background: #0a0a0a; scroll-behavior: smooth; position: relative; }
#grid { 
        display: grid; 
        grid-template-columns: repeat(50, 1fr); 
        gap: 0px; 
        
        height: 100%; 
        width: 3616px; /* ë§µ ì „ì²´ ê¸¸ì´ */
        padding: 0; 
        
        /* [í•µì‹¬] íƒ€ì¼ì„ ë°”ë‹¥ì— ë¶™ì„ (margin-top ëŒ€ì‹  ì‚¬ìš©) */
        align-items: end;      /* ì„¸ë¡œ ì •ë ¬: ë°”ë‹¥ */
        align-content: end;    /* ì„¸ë¡œ ì •ë ¬: ë°”ë‹¥ */
        padding-bottom: 0px;  /* ë°”ë‹¥ì—ì„œ ì•½ê°„ ë„ìš°ê¸° (ë„ë¡œ ìœ„ì¹˜ì— ë§ê²Œ ì¡°ì ˆ) */
        
        background-color: #111; 
        background-image: url('images/map_bg.png'); 
        background-size: 100% 100%; 
        background-position: center; 
        background-repeat: no-repeat;
    }

    /* Modals */
    .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .modal-box { width: 90%; max-width: 600px; background: #222; border: 2px solid var(--gold); border-radius: 12px; padding: 10px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); max-height: 90%; overflow-y: auto; transition: 0.3s; }
    .modal-title { font-family: 'Do Hyeon'; font-size: 18px; color: var(--gold); margin-bottom: 4px; }
    .modal-msg { font-size: 12px; line-height: 1.5; color: #ddd; margin-bottom: 15px; white-space: pre-wrap; width: 100%; }
    .modal-choices { display: flex; flex-direction: column; gap: 8px; }
    .choice-btn { width: 100%; padding: 12px; background: #333; border: 1px solid #555; color: white; font-family: 'Do Hyeon'; border-radius: 6px; font-size: 15px; margin-bottom: 5px; cursor: pointer; }
    
    .modal-box.boss-theme { border-color: #f00; background: #1a0000; box-shadow: 0 0 30px #f00; animation: boss-pulse 2s infinite; }
    .modal-box.boss-theme .modal-title { color: #f00; text-shadow: 0 0 5px #f00; }

    /* Battle Visuals */
    .battle-scene { display: flex; justify-content: space-around; align-items: center; margin-bottom: 10px; height: 100px; position: relative; }
    .battler-wrap { position: relative; width: 80px; height: 100px; display: flex; justify-content: center; align-items: flex-end; }
    .battler-img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.2s; }
    .p1-side .battler-img { filter: drop-shadow(0 0 15px var(--p1-color)); }
    .enemy-side .battler-img { filter: drop-shadow(0 0 15px red); }
    .battler-flip { transform: scaleX(-1); }

    .battle-visual-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #111; padding: 8px; border-radius: 8px; border: 1px solid #444; box-shadow: inset 0 0 10px #000; }
    .bv-side { width: 45%; }
    .bv-name { font-size: 12px; font-weight: bold; margin-bottom: 4px; color: #eee; text-align: left; text-shadow: 1px 1px 0 #000; }
    .bv-bar-bg { width: 100%; height: 24px; background: #222; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid #555; }
    .bv-bar-fill { height: 100%; width: 100%; transition: width 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); box-shadow: inset 0 2px 5px rgba(255,255,255,0.2); }
    .bv-bar-fill.hit { animation: bar-flash 0.2s, bar-shake 0.3s; }
    .bv-bar-txt { position: absolute; top: 0; left: 0; width: 100%; height: 100%; font-size: 14px; color: white; text-align: center; line-height: 24px; font-weight: bold; text-shadow: 1px 1px 2px #000; z-index: 2; }
    .p1-bv-fill { background: linear-gradient(90deg, #4CAF50, #81C784); }
    .enemy-bv-fill { background: linear-gradient(90deg, #E91E63, #F48FB1); }

    /* Battle Preview */
    .battle-preview-wrap { display: flex; justify-content: space-between; align-items: stretch; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 12px; margin-bottom: 5px; }
    .preview-card { flex: 1; display: flex; flex-direction: column; align-items: center; background: #222; border: 2px solid #555; border-radius: 7px; padding: 8px; }
    .p-img-box { width: 80px; height: 80px; margin-bottom: 5px; }
    .stat-box { width: 80%; text-align: left; margin-top: 4px; }
    .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 1px 0; font-size: 12px; }
    .stat-label { color: #aaa; font-size: 11px }
    .stat-val { font-family: 'Black Han Sans', sans-serif; font-size: 13px; color: #fff; text-shadow: 1px 1px 0 #000; }
    .preview-flip { transform: scaleX(-1); }

    /* Shop UI */
    .shop-header-gold { font-size: 20px; color: #FFD700; font-weight: bold; margin-bottom: 15px; text-align: center; background: #222; padding: 12px; border-radius: 8px; border: 1px solid #555; box-shadow: 0 4px 6px rgba(0,0,0,0.5); position: sticky; top: 0; z-index: 15; }
    .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-bottom: 10px; }
    .shop-cat-header { grid-column: span 2; font-size: 16px; color: #b388ff; margin-top: 15px; margin-bottom: 5px; text-align: left; border-bottom: 2px solid #444; padding-bottom: 5px; font-family: 'Do Hyeon', sans-serif; }
    .shop-card { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 8px; display: flex; flex-direction: row; align-items: center; gap: 10px; min-height: 120px; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .shop-card:active { transform: scale(0.98); background: #333; }
    .shop-icon { width: 90px; height: 90px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 50px; background: #151515; border-radius: 8px; border: 1px solid #333; padding: 0; overflow: hidden; position: relative; }
    .shop-img { width: 100% !important; height: 100% !important; object-fit: contain; display: block; image-rendering: pixelated; }
    .shop-right-col { flex: 1; display: flex; flex-direction: column; justify-content: space-between; height: 100%; text-align: left; min-height: 90px; }
    .item-name { font-weight: bold; color: white; font-size: 15px; margin-bottom: 2px; line-height: 1.2; }
    .item-stat { font-size: 12px; color: #bbb; margin-bottom: auto; line-height: 1.3; }
    .buy-btn { width: 100%; background: linear-gradient(135deg, #FFD700, #FFA000); border: none; padding: 8px 0; border-radius: 4px; font-weight: bold; font-family: 'Do Hyeon'; font-size: 14px; cursor: pointer; color: #222; margin-top: 6px; box-shadow: 0 2px 3px rgba(0,0,0,0.3); }
    .buy-btn:active { background: #E6C200; transform: translateY(1px); }

    /* Controls & Others */
    #controls { height: 120px; background: var(--panel-bg); border-top: 2px solid #333; padding: 10px; display: flex; flex-direction: column; z-index: 20; }
    .ctrl-row { display: flex; gap: 8px; margin-bottom: 8px; flex: 1; }
    .c-btn { flex: 1; background: #2a2a2a; border: 1px solid #444; color: #ccc; border-radius: 6px; font-size: 12px; font-weight: bold; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; }
    .c-btn:active { background: #333; }
    .c-btn.active { border-color: gold; color: white; background: #4a3b00; box-shadow: 0 0 5px gold; }
    .c-btn.passive { border-color: #555; background: #1a1a1a; color: #aaa; cursor: pointer; }
    .roll-btn { width: 100%; height: 45px; background: #eee; color: black; font-family: 'Do Hyeon'; font-size: 20px; border-radius: 6px; border:none; }
    .roll-btn:disabled { background: #555; color: #888; cursor: not-allowed; }
    .badge { position: absolute; top: 2px; right: 2px; background: red; color: white; font-size: 9px; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    #turn-msg { position: absolute; bottom: 130px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold; z-index: 50; pointer-events: none; white-space: nowrap;}
    #doom-timer { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); color: red; font-family: 'Black Han Sans'; font-size: 24px; text-shadow: 2px 2px 0 black; z-index: 60; display: none; animation: pulse 1s infinite; }

    /* Setup & Gacha */
    .class-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; padding:20px; }
    .class-card { background: #252525; border: 2px solid #444; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; }
    .class-card:hover { border-color: var(--gold); background: #333; }
    .c-icon { font-size: 30px; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; }
    .c-name { font-size: 18px; color: white; margin-bottom: 5px; font-family: 'Do Hyeon'; }
    .c-desc { font-size: 11px; color: #aaa; line-height: 1.4; }
    #screen-setup { padding: 15px; }
    .gacha-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .gacha-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; margin-bottom: 20px; }
    .merc-card { 
    background: #1a1a1a; 
    border: 1px solid #444; 
    border-radius: 6px; 
    padding: 10px; 
    text-align: center; 
    font-size: 11px;
    transition: all 0.3s ease;
}

/* ë“±ê¸‰ë³„ í…ìŠ¤íŠ¸ ë° í…Œë‘ë¦¬ ê°•ì¡° */

/* 1. ì¼ë°˜ (Common) */
.merc-card.common { border-color: #888; color: #eee; }

/* 2. ì–¸ì»¤ë¨¼ (Uncommon) */
.merc-card.uncommon { 
    border-color: #4caf50; 
    box-shadow: inset 0 0 10px rgba(76, 175, 80, 0.2);
}
.merc-card.uncommon .merc-name { color: #4caf50 !important; }

/* 3. ë ˆì–´ (Rare) */
.merc-card.rare { 
    border-color: #2196f3; 
    box-shadow: inset 0 0 10px rgba(33, 150, 243, 0.3);
}
.merc-card.rare .merc-name { color: #2196f3 !important; text-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }

/* 4. ì „ì„¤ (Legend) */
.merc-card.legend { 
    border-color: #ffca28; 
    background: linear-gradient(145deg, #1a1a1a, #2a2400);
    box-shadow: 0 0 15px rgba(255, 202, 40, 0.4), inset 0 0 10px rgba(255, 202, 40, 0.2);
    animation: legend-pulse 2s infinite;
}
.merc-card.legend .merc-name { 
    color: #ffca28 !important; 
    text-shadow: 0 0 8px rgba(255, 202, 40, 0.6);
    font-weight: bold;
}

/* ì „ì„¤ ë“±ê¸‰ ë°˜ì§ì„ íš¨ê³¼ */
@keyframes legend-pulse {
    0% { border-color: #ffca28; }
    50% { border-color: #fff176; }
    100% { border-color: #ffca28; }
}
    .merc-name { font-family: 'Do Hyeon'; font-size: 13px; margin-bottom: 4px; color: #fff; }
    .merc-card.legend { border-color: gold; box-shadow: 0 0 5px gold; }
    .placement-area { flex: 1; display: none; flex-direction: column; }
    .hand-container { display: flex; justify-content: center; gap: 10px; padding: 10px; background: #181818; border-radius: 8px; margin-bottom: 20px; min-height: 120px; border: 1px dashed #444; }
    .dragger { width: 70px; height: 100px; background: #333; border: 1px solid #666; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; cursor: grab; z-index: 50; text-align: center; }
    .dragger.placed { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
    .slot-container { display: flex; justify-content: space-around; margin-bottom: 20px; }
    .stat-slot { width: 75px; height: 110px; background: #111; border: 2px dashed #555; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #777; font-size: 12px; position: relative; }
    .stat-slot.filled { border-style: solid; border-color: var(--p1-color); background: #1b3a1b; color: white; animation: none; }

    /* Images */
    .img-asset { width: 100%; height: 100%; object-fit: contain; display: block; }
    .pawn-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5)); }
    .shop-img { width: 30px; height: 30px; object-fit: contain; }
    .item-img { width: 100%; height: 100%; object-fit: contain; }

    /* ------------------------------------------------------------------ */
    /* [ìµœì¢… ìˆ˜ì •] íƒ€ì¼ ê³ ì • / ìºë¦­í„°ë§Œ ë‘¥ì‹¤ë‘¥ì‹¤ / ê·¸ë¦¼ì í‘œì‹œ */
    /* ------------------------------------------------------------------ */

.tile, .tile-monster, .tile-end, .tile-start {
        position: relative !important;
        transform: none !important;
        animation: none !important;
        z-index: 1;
        overflow: visible !important;
        
        height: 60px !important;
        min-height: 60px !important;
        width: 100% !important;
        
        display: flex;
        align-items: center;
        justify-content: center;
        
        color: #555; 
    }
    
    .tile-start { color: lime; font-weight: bold; text-shadow: 1px 1px 2px black; }
    .tile-end { color: red; font-weight: bold; text-shadow: 1px 1px 2px black; }

    /* 2. ê»ë°ê¸°(Wrapper): íƒ€ì¼ ë ˆì´ì•„ì›ƒì—ì„œ 'ì œì™¸'ì‹œì¼œ ê³µì¤‘ì— ë„ì›€ (Absolute) */
    .pawn, .obj-wrap {
        position: absolute !important; /* [í•µì‹¬] íƒ€ì¼ íë¦„ì—ì„œ ì™„ì „íˆ ëºŒ */
        
        /* ìœ„ì¹˜ ì¡ê¸°: íƒ€ì¼ ë°”ë‹¥ ì¤‘ì•™ */
        bottom: -10px !important;
        left: 50% !important;
        transform: translateX(-50%) !important; /* ì¢Œìš° ì •ë ¬ë§Œ í•¨ (ìœ„ì•„ë˜ ì›€ì§ì„ X) */
        
        /* ì •ë ¬ */
        display: flex;
        justify-content: center;
        align-items: flex-end;
        
        width: auto;
        height: auto;
        pointer-events: none;
        z-index: 10;
        
        /* ê»ë°ê¸°ë„ ì›€ì§ì´ì§€ ì•ŠìŒ */
        animation: none !important; 
    }

/* [ìˆ˜ì •] ì• ë‹ˆë©”ì´ì…˜: ì¢Œìš° í”ë“¤ë¦¼ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ Xì¶•ì€ ê±´ë“œë¦¬ì§€ ì•Šê³  Yì¶•(ìœ„ì•„ë˜)ë§Œ ì¡°ì ˆ */
@keyframes float-breathing {
    0%   { transform: translateY(0) scale(1); }
    50%  { transform: translateY(-8px) scale(1.05); }
    100% { transform: translateY(0) scale(1); }
}

/* [ìˆ˜ì •] ê·¸ë¦¼ì ì• ë‹ˆë©”ì´ì…˜ */
@keyframes shadow-breathing {
    0%   { transform: scale(1); opacity: 0.9; }
    50%  { transform: scale(1.2); opacity: 0.5; }
    100% { transform: scale(1); opacity: 0.9; }
}

/* [ìˆ˜ì •] ìºë¦­í„° ë°°ì¹˜ ê¸°ì¤€ì  */
.pawn, .obj-wrap {
    position: absolute !important;
    bottom: 10px !important; 
    left: 50% !important;
    /* ê¸°ì¤€ì ì„ ì¤‘ì•™ìœ¼ë¡œ ì¡ê³ , ì´í›„ ì• ë‹ˆë©”ì´ì…˜ì€ ìœ„ì•„ë˜ë¡œë§Œ ì‘ë™ */
    transform: translateX(-50%) !important; 
    width: 1px; height: 1px;
    display: flex; 
    justify-content: center; 
    align-items: flex-end;
    z-index: 100;
    pointer-events: none;
}

.pawn-img, .monster-img, .obj-wrap img {
    width: 110px !important;
    height: 110px !important;
    object-fit: contain;
    /* í•µì‹¬: translateXë¥¼ í¬í•¨í•˜ì§€ ì•Šì€ Yì¶• ì „ìš© ì• ë‹ˆë©”ì´ì…˜ ì ìš© */
    animation: float-breathing 3s infinite ease-in-out;
    transform-origin: bottom center;
    will-change: transform;
}

/* [ìˆ˜ì •] ê·¸ë¦¼ì: ë¶€ëª¨ê°€ ì´ë¯¸ ì¤‘ì•™ì´ë¯€ë¡œ leftë§Œ 50% ì£¼ë©´ ë¨ */
.pawn::after, .obj-wrap::after {
    content: '';
    display: block;
    position: absolute;
    left: -40px; /* ê·¸ë¦¼ì ë„ˆë¹„ì˜ ì ˆë°˜ë§Œí¼ ì™¼ìª½ìœ¼ë¡œ */
    bottom: -5px;
    width: 80px; 
    height: 15px;
    background: radial-gradient(ellipse at center, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 70%);
    border-radius: 50%;
    z-index: -1;
    animation: shadow-breathing 3s infinite ease-in-out;
}
    /* 4. ë§ˆì™•(Boss) ë° ëŒ€í˜• ëª¬ìŠ¤í„° í¬ê¸° ë³´ì • */
    .tile-end .obj-wrap img { 
        width: 180px !important; 
        height: 180px !important; 
    }
    .tile-end .obj-wrap::after { 
        width: 140px; 
        height: 30px; 
    }

    /* 5. ì—‡ë°•ì ì ìš© (ìì—°ìŠ¤ëŸ¬ì›€) */
    .tile:nth-child(even) .pawn-img,
    .tile:nth-child(even) .obj-wrap img,
    .tile:nth-child(even) .pawn::after,
    .tile:nth-child(even) .obj-wrap::after {
        animation-delay: 1s;
    }
/* ëª¬ìŠ¤í„° ì´ë¯¸ì§€ ê³µí†µ: í¬ê¸°ëŠ” JSì—ì„œ ë¶€ì—¬í•œ ìˆ«ìë¡œ ê²°ì •ë¨ */
    .monster-img {
        object-fit: contain;
    display: block; 
    position: absolute !important;
    bottom: 0;
    left: 50% !important;
    transform: translateX(-50%) !important;
    animation: float-breathing 3s infinite ease-in-out;
    transform-origin: bottom center;
    will-change: transform;
    z-index: 20;
}
@media (max-width: 500px) {
        /* ëª¨ë°”ì¼ì—ì„œë§Œ ë°”ë€Œì–´ì•¼ í•˜ëŠ” ë¶€ë¶„ë§Œ ê³¨ë¼ì„œ ì‘ì„± */
        #hud {
            height: 280px; 
        }
        .p-panel {
            font-size: 11px;
        }
        .pawn-img, .monster-img {
            width: 80px !important; /* ëª¨ë°”ì¼ì—ì„œëŠ” ìºë¦­í„° í¬ê¸°ë¥¼ ì¤„ì„ */
            height: 80px !important;
        }
        .roll-btn {
            height: 55px;
            font-size: 18px;
        }
    }
</style>
</head>
<body>

<div id="game-wrapper">
    <div id="screen-class" class="screen active-screen">
        <h2 class="font-header" style="color:white; margin-bottom:20px;">ì§€ë„ì ì„ íƒ</h2>
        <div class="class-grid"></div>
    </div>

    <div id="screen-setup" class="screen">
        <div class="gacha-area" id="gacha-view">
            <h2 class="font-header" style="color:var(--gold)">ìš©ë³‘ë‹¨ ì†Œí™˜</h2>
            <div class="gacha-grid" id="gacha-list"></div>
            <button class="btn-main" id="btn-summon" onclick="Setup.summon()">ì†Œí™˜ (0/4)</button>
        </div>
        <div class="placement-area" id="place-view">
            <div style="text-align:center; color:#888; font-size:12px; margin-bottom:10px;">
                ëŠ¥ë ¥ì¹˜ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìŠ¬ë¡¯ì— ë°°ì¹˜í•˜ì„¸ìš”<br>
            </div>
            <div class="hand-container" id="hand"></div>
            <div class="slot-container">
                <div class="stat-slot" data-type="move" id="slot-move">ì´ë™<br><span>-</span></div>
                <div class="stat-slot" data-type="atk" id="slot-atk">ê³µê²©<br><span>-</span></div>
                <div class="stat-slot" data-type="def" id="slot-def">ë°©ì–´<br><span>-</span></div>
                <div class="stat-slot" data-type="luck" id="slot-luck">ìš´<br><span>-</span></div>
            </div>
            <button class="btn-main" onclick="Setup.finish()" style="margin-top:auto;">ëª¨í—˜ ì‹œì‘</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="hud">
            <div class="top-bar">
                <span id="ui-job" style="font-weight:bold; color:#ddd">JOB</span>
                <span><span id="ui-lv" style="color:#00e676; margin-right:8px;">Lv.1</span><span id="ui-gold" style="color:gold">0 G</span></span>
            </div>
            <div class="p-stats-wrapper">
                <div class="p-panel p1-panel" id="hud-p1"></div>
                <div class="p-panel p2-panel" id="hud-p2"></div>
            </div>
            <div class="boss-bar-wrap">
                <div class="boss-hp-fill" id="boss-hp-fill"></div>
                <div class="boss-text" id="boss-hp-txt">ë§ˆì™• HP: 50</div>
            </div>
        </div>
        
        <div id="doom-timer"></div>
        <div id="turn-msg">ì¤€ë¹„ ì¤‘...</div>
        
        <div id="board-container">
            <div id="grid"></div>
        </div>

        <div id="controls">
            <div class="ctrl-row">
                <button class="c-btn active" id="btn-cam" onclick="Game.toggleCamera()">ğŸ¥ì‹œì ê³ ì •</button>
                
                <button class="c-btn" id="btn-skill" onclick="Game.onSkillBtnClick()">ìŠ¤í‚¬</button>
                <button class="c-btn" onclick="Game.usePotion()">ğŸ§ªë¬¼ì•½<div class="badge" id="ui-pot">0</div></button>
                <button class="c-btn" onclick="Shop.open()">ğŸ›’ìƒì </button>
            </div>
            <button class="roll-btn" id="btn-roll" onclick="Game.roll(false)">ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
        </div>
    </div>

    <div id="modal-gen" class="modal-overlay">
        <div class="modal-box" id="modal-box-gen">
            <div id="m-title" class="modal-title"></div>
            <div id="m-msg" class="modal-msg"></div>
            <div id="m-choices" class="modal-choices"></div>
            <button id="m-ok" class="choice-btn" style="margin-top:10px; background:#444;">í™•ì¸</button>
        </div>
    </div>

    <div id="modal-shop" class="modal-overlay">
        <div class="modal-box" style="border-color:#448aff; width:95%; max-width:600px;">
            <div class="modal-title" style="color:#448aff;">ğŸ›’ ë§Œë¬¼ìƒ</div>
            <div id="shop-items" style="max-height:400px; overflow-y:auto;"></div>
            <button class="choice-btn" onclick="Shop.close()" style="margin-top:10px;">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="modal-end" class="modal-overlay">
        <div class="modal-box" style="border-color:white;">
            <div id="end-title" class="modal-title" style="font-size:32px;">VICTORY</div>
            <div id="end-content" style="text-align:left; background:#111; padding:10px; margin-bottom:15px; border-radius:5px;"></div>
            <button class="choice-btn" style="background:gold; color:black; font-weight:bold;" onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
    </div>
</div>

<script>
/* --- Config & Data --- */
const IMG_SRC = {
    // 1ì°¨ ì§ì—…
    warrior: 'images/warrior.png',
    knight: 'images/knight.png',
    rogue: 'images/rogue.png',
    hunter: 'images/hunter.png',
    mage: 'images/mage.png',
    explorer: 'images/explorer.png',
    
    // 2ì°¨ ì „ì§
    berserker: 'images/berserker.png',
    paladin: 'images/paladin.png',
    guardian: 'images/guardian.png',
    avenger: 'images/avenger.png',
    assassin: 'images/assassin.png',
    phantom: 'images/phantom.png',
    sniper: 'images/sniper.png',
    ranger: 'images/ranger.png',
    archmage: 'images/archmage.png',
    warlock: 'images/warlock.png',
    alchemist: 'images/alchemist.png',
    pathfinder: 'images/pathfinder.png',

    // ëª¬ìŠ¤í„°
    'ìŠ¬ë¼ì„': 'images/slime.png',
    'ê³ ë¸”ë¦°': 'images/goblin.png',
    'ì˜¤í¬': 'images/orc.png',
    'ìŠ¤ì¼ˆë ˆí†¤': 'images/skeleton.png',
    'ì¢€ë¹„': 'images/zombie.png',
    'íŠ¸ë¡¤': 'images/troll.png',
    'ê³¨ë ˜': 'images/golem.png',
    'ê°€ê³ ì¼': 'images/gargoyle.png',
    'ë¦¬ì¹˜': 'images/lich.png',
    'ë“œë˜ê³¤': 'images/dragon.png',
    
    // íŠ¹ìˆ˜
    boss: 'images/boss.png',
    enemy: 'images/enemy.png',
    
    // ì•„ì´í…œ
    'ê°€ì£½ ë¶€ì¸ ': 'images/boots_leather.png',
    'ë°”ëŒì˜ ì‹ ë°œ': 'images/boots_wind.png',
    'í—¤ë¥´ë©”ìŠ¤ ë¶€ì¸ ': 'images/boots_hermes.png',
    'ë…¹ìŠ¨ ê²€': 'images/sword_rusty.png',
    'ê¸°ì‚¬ì˜ ê²€': 'images/sword_knight.png',
    'ë§ˆë²• ì§€íŒ¡ì´': 'images/staff_magic.png',
    'ë¯¸ìŠ¤ë¦´ ê²€': 'images/sword_mithril.png',
    'ê°€ì£½ ê°‘ì˜·': 'images/armor_leather.png',
    'íŒê¸ˆ ê°‘ì˜·': 'images/armor_plate.png',
    'ìš©ì˜ ë¹„ëŠ˜': 'images/armor_dragon.png',
    'ì„±ê¸°ì‚¬ì˜ ë°©íŒ¨': 'images/shield_paladin.png',
    'í–‰ìš´ ë¶€ì ': 'images/acc_charm.png',
    'í™©ê¸ˆ ë°˜ì§€': 'images/acc_goldring.png',

    // íƒ€ì¼
    tile_fire: 'images/tile_fire.png',
    tile_ice: 'images/tile_ice.png',
    tile_event: 'images/tile_event.png',
    tile_seal: 'images/tile_seal.png',
    tile_heal: 'images/tile_heal.png',
    tile_job: 'images/tile_job.png',

    // ìœ ë¬¼
    vamp: 'images/art_vamp.png',
    thorn: 'images/art_thorn.png',
    greed: 'images/art_greed.png',
    glass: 'images/art_glass.png',
    boots: 'images/art_boots.png',
    lucky: 'images/art_lucky.png',

    // ìŠ¤í‚¬
    skill_fury: 'images/skill_fury.png',
    skill_divine: 'images/skill_divine.png',
    skill_iron: 'images/skill_iron.png',
    skill_revenge: 'images/skill_revenge.png',
    skill_vital: 'images/skill_vital.png',
    skill_shadow: 'images/skill_shadow.png',
    skill_weakness: 'images/skill_weakness.png',
    skill_wind: 'images/skill_wind.png',
    skill_meteor: 'images/skill_meteor.png',
    skill_soul: 'images/skill_soul.png',
    skill_poison: 'images/skill_poison.png',
    skill_shortcut: 'images/skill_shortcut.png'
};

const getImgTag = (key, altClass='', fallbackEmoji='') => {
    if(IMG_SRC[key]) return `<img src="${IMG_SRC[key]}" class="${altClass}" onerror="this.style.display='none';this.parentNode.innerText='${fallbackEmoji}'">`;
    return fallbackEmoji;
};

const CLASSES = {
    warrior: {n:'ì „ì‚¬', desc:'ì²´ë ¥+30, ê³µê²©+2', i:'âš”ï¸', main:'atk'},
    knight: {n:'ê¸°ì‚¬', desc:'ì²´ë ¥+40, ë°©ì–´+2', i:'ğŸ›¡ï¸', main:'def'},
    rogue: {n:'ë„ì ', desc:'ê³¨ë“œ+100, ìš´+2', i:'ğŸ€', main:'luck'},
    hunter: {n:'ì‚¬ëƒ¥ê¾¼', desc:'ê³µê²©/ì´ë™+1', i:'ğŸ¹', main:'atk'},
    mage: {n:'ë§ˆë²•ì‚¬', desc:'ì²´ë ¥-20, ê³µê²©+3', i:'ğŸ”®', main:'atk'},
    explorer: {n:'íƒí—˜ê°€', desc:'ì´ë™+2, ë¬¼ì•½ 2ê°œ', i:'ğŸ¦¶', main:'move'}
};

const JOBS = {
    warrior: [
        {id:'berserker', n:'ê´‘ì „ì‚¬', sn:'í”¼ì˜ ê²©ë…¸', desc:'[íŒ¨ì‹œë¸Œ] HP 26 ì´ìƒ ì‹œ, HP 25 ì†Œëª¨í•˜ì—¬ ê³µê²©ë ¥ 2ë°°', i:'ğŸ©¸', type:'passive'},
        {id:'paladin', n:'ì„±ê¸°ì‚¬', sn:'ì‹ ì˜ ê°€í˜¸', desc:'[íŒ¨ì‹œë¸Œ] ë§¤ í„´ ì‹œì‘ ì‹œ ìµœëŒ€ ì²´ë ¥(MaxHP)ì˜ 10%ë§Œí¼ íšŒë³µ', i:'â›ª', type:'passive'}
    ],
    knight: [
        {id:'guardian', n:'ê°€ë””ì–¸', sn:'ì² ë²½ ë°©ì–´', desc:'[íŒ¨ì‹œë¸Œ] ì „íˆ¬ ë°˜ë™ ë° ëª¨ë“  í”¼ê²© ë°ë¯¸ì§€ -3 ê°ì†Œ', i:'ğŸ°', type:'passive'},
        {id:'avenger', n:'ì–´ë²¤ì ¸', sn:'ë³µìˆ˜ì˜ ì¹¼ë‚ ', desc:'[íŒ¨ì‹œë¸Œ] ë°©ì–´ ì‹œ, ë‚´ ë°©ì–´ë ¥ ìˆ˜ì¹˜ë§Œí¼ ì ì—ê²Œ í™•ì • ë°˜ì‚¬', i:'âš”ï¸', type:'passive'}
    ],
    rogue: [
        {id:'assassin', n:'ì–´ìŒ”ì‹ ', sn:'ê¸‰ì†Œ ê°€ê²©', desc:'[íŒ¨ì‹œë¸Œ] ê³µê²© ì‹œ, í˜„ì¬ ìš´(Luck) ìˆ˜ì¹˜ì˜ 2ë°°ë§Œí¼ ê³µê²©ë ¥ ì¶”ê°€', i:'ğŸ—¡ï¸', type:'passive'},
        {id:'phantom', n:'íŒ¬í…€', sn:'ê·¸ë¦¼ì ë§í† ', desc:'[íŒ¨ì‹œë¸Œ] í”¼ê²© ì‹œ 30% í™•ë¥ ë¡œ ì™„ì „ íšŒí”¼', i:'ğŸ‘»', type:'passive'}
    ],
    hunter: [
        {id:'sniper', n:'ìŠ¤ë‚˜ì´í¼', sn:'ì•½ì  í¬ì°©', desc:'[íŒ¨ì‹œë¸Œ] ì  ë°©ì–´ë ¥ì„ 50%ë§Œ ì ìš© (ë°©ì–´ ê´€í†µ)', i:'ğŸ¯', type:'passive'},
        {id:'ranger', n:'ë ˆì¸ì €', sn:'ë°”ëŒì˜ ì‚¬ê²©', desc:'[íŒ¨ì‹œë¸Œ] ì´ë™í•œ ì¹¸ ìˆ˜ë§Œí¼ ê³µê²©ë ¥ ì¶”ê°€', i:'ğŸŒªï¸', type:'passive'}
    ],
    mage: [
        {id:'archmage', n:'ëŒ€ë§ˆë²•ì‚¬', sn:'ë©”í…Œì˜¤ ìŠ¤íŠ¸ë¼ì´í¬', desc:'[ì•¡í‹°ë¸Œ] ì¿¨íƒ€ì„ 3í„´. ë‹¤ìŒ ì „íˆ¬ ê³ ì • í”¼í•´ 20 (í´ë¦­ ì‹œ ì‚¬ìš©)', i:'âš¡', type:'active'},
        {id:'warlock', n:'í‘ë§ˆë²•ì‚¬', sn:'ì˜í˜¼ ì°©ì·¨', desc:'[íŒ¨ì‹œë¸Œ] 50G ì†Œëª¨í•˜ì—¬ ì¶”ê°€ í”¼í•´ +15', i:'ğŸ’€', type:'passive'}
    ],
    explorer: [
        {id:'alchemist', n:'ì—°ê¸ˆìˆ ì‚¬', sn:'ë…ì„± íˆ¬ì²™', desc:'[íŒ¨ì‹œë¸Œ] ë¬¼ì•½ ì‚¬ìš© ì‹œ ì²´ë ¥ íšŒë³µ + ì ì—ê²Œ 10 ë… ë°ë¯¸ì§€', i:'âš—ï¸', type:'passive'},
        {id:'pathfinder', n:'ê°œì²™ì', sn:'ì§€ë¦„ê¸¸ ë°œê²¬', desc:'[íŒ¨ì‹œë¸Œ] ì´ë™ ì£¼ì‚¬ìœ„ êµ´ë¦¼ ì‹œ ìµœì†Œê°’ 4 ë³´ì¥', i:'ğŸ§­', type:'passive'}
    ]
};

const ITEMS_DB = [
    {n:"ê°€ì£½ ë¶€ì¸ ", type:"s", val:1, cost:50, desc:"ì´ë™+1", icon:"ğŸ‘Ÿ", rank:0},
    {n:"ë°”ëŒì˜ ì‹ ë°œ", type:"s", val:2, cost:100, desc:"ì´ë™+2", icon:"ğŸ‘Ÿ", rank:1},
    {n:"í—¤ë¥´ë©”ìŠ¤ ë¶€ì¸ ", type:"s", val:4, cost:220, desc:"ì´ë™+4", icon:"ğŸ‘Ÿ", rank:3},
    {n:"ë…¹ìŠ¨ ê²€", type:"w", val:2, cost:50, desc:"ê³µê²©+2", icon:"âš”ï¸", rank:0},
    {n:"ê¸°ì‚¬ì˜ ê²€", type:"w", val:4, cost:120, desc:"ê³µê²©+4", icon:"âš”ï¸", rank:1},
    {n:"ë§ˆë²• ì§€íŒ¡ì´", type:"w", val:6, cost:200, desc:"ê³µê²©+6", icon:"ğŸ”®", rank:2},
    {n:"ë¯¸ìŠ¤ë¦´ ê²€", type:"w", val:7, cost:250, desc:"ê³µê²©+7", icon:"âš”ï¸", rank:3},
    {n:"ê°€ì£½ ê°‘ì˜·", type:"a", val:2, cost:50, desc:"ë°©ì–´+2", icon:"ğŸ›¡ï¸", rank:0},
    {n:"íŒê¸ˆ ê°‘ì˜·", type:"a", val:4, cost:120, desc:"ë°©ì–´+4", icon:"ğŸ›¡ï¸", rank:1},
    {n:"ìš©ì˜ ë¹„ëŠ˜", type:"a", val:6, cost:200, desc:"ë°©ì–´+6", icon:"ğŸ›¡ï¸", rank:2},
    {n:"ì„±ê¸°ì‚¬ì˜ ë°©íŒ¨", type:"a", val:8, cost:300, desc:"ë°©ì–´+8", icon:"ğŸ›¡ï¸", rank:3},
    {n:"í–‰ìš´ ë¶€ì ", type:"acc", val:2, cost:80, desc:"ìš´+2", icon:"ğŸ’", rank:1},
    {n:"í™©ê¸ˆ ë°˜ì§€", type:"acc", val:4, cost:150, desc:"ìš´+4", icon:"ğŸ’", rank:2}
];

const ARTIFACTS = [
    {id:'vamp', n:'ğŸ©¸ í¡í˜ˆì˜ ê´­ì´', desc:'ê³µê²© ì‹œ ì²´ë ¥ 5 íšŒë³µ', icon:'ğŸ©¸'},
    {id:'thorn', n:'ğŸŒµ ê°€ì‹œ ê°‘ì˜·', desc:'í”¼ê²© ì‹œ ì ì—ê²Œ 5 ë°ë¯¸ì§€ ë°˜ì‚¬', icon:'ğŸŒµ'},
    {id:'greed', n:'ğŸ’° íƒìš•ì˜ í•­ì•„ë¦¬', desc:'ë§¤ í„´ ê³¨ë“œ íšë“ 2ë°°', icon:'ğŸ’°'},
    {id:'glass', n:'ğŸ· ìœ ë¦¬ ëŒ€í¬', desc:'ê³µê²©ë ¥ +5, ë°›ëŠ” í”¼í•´ +5', icon:'ğŸ·'},
    {id:'boots', n:'ğŸ‘ í—¤ë¥´ë©”ìŠ¤ì˜ ë‚ ê°œ', desc:'ì´ë™ ì£¼ì‚¬ìœ„ +1', icon:'ğŸ‘'},
    {id:'lucky', n:'ğŸ€ ë„¤ìí´ë¡œë²„', desc:'ìš´(Luck) +2', icon:'ğŸ€'}
];

const MONSTERS = ["ìŠ¬ë¼ì„","ê³ ë¸”ë¦°","ì˜¤í¬","ìŠ¤ì¼ˆë ˆí†¤","ì¢€ë¹„","íŠ¸ë¡¤","ê³¨ë ˜","ê°€ê³ ì¼","ë¦¬ì¹˜","ë“œë˜ê³¤"];
const MON_STATS = [ {mn:1,mx:5},{mn:2,mx:7},{mn:3,mx:9},{mn:3,mx:11},{mn:3,mx:13},{mn:4,mx:13},{mn:4,mx:15},{mn:4,mx:17},{mn:4,mx:19},{mn:5,mx:20} ];
const MON_SIZES = [
    {w:50, h:50}, {w:60, h:60}, {w:110, h:110}, {w:70, h:90}, {w:75, h:75}, 
    {w:110, h:100}, {w:180, h:180}, {w:100, h:100}, {w:100, h:130}, {w:200, h:200}
];

const FIRST_NAMES = ["ê°€ì›¨ì¸","ê°€ë¸Œë¦¬ì—˜","ê·¸ë ˆì´","ê¸°ë“œì˜¨","ê°ˆë¦¬ì˜¤","ê·¸ì›¬","ë‚˜íƒˆë¦¬","ë…¹ìŠ¤","ë‹ˆì½”","ë…¸ì•„","ë„¤ë¡œ","ë‹¤ë¦¬ìš°ìŠ¤","ë‹¨í…Œ","ë¸ë¼","ë„ë¦¬ì•ˆ","ë“œë ˆì´í¬","ë””ì•ˆ","ë¼ìŠ¤","ë¼ì¹¸","ë ˆì˜¤","ë ˆì´ë¸","ë ‰ìŠ¤","ë¡œê±´","ë£¨ë‚˜","ë£¨í¬","ë¦¬ì•ˆ","ë¦´ë¦¬","ë ˆì˜¨","ë¡œì œ","ë§ˆê·¸ëˆ„ìŠ¤","ë©”ì´","ë¯¸ë¼","ë¯¸ì¹´ì—˜","ë§ì½¤","ë°”ë¡ ","ë°œíŠ¸","ë² ë¦­","ë²¨ë¼","ë¹„ì˜¤","ë¹…í„°","ë¹ˆì„¼íŠ¸","ì‚¬ë¼","ì„¸ë¼","ì„¸ì‹¤","ì†Œë¼","ì†”","ì‹œì˜¨","ì‹¤ë¹„ì•„","ì„¸ì¸","ì•„ë¡ ","ì•„ë²¨","ì•„ì´ì‘","ì•Œë Œ","ì•Œë¦­","ì—ë°˜","ì—ì‹¤ë¼","ì—ì´ë“ ","ì—˜ë¦¬","ì—˜ë¦­","ì˜¤ì›¬","ìš”í•œ","ì´ë¦¬ìŠ¤","ì´ì•ˆ","ìí¬","ì œë“œ","ì œë¼ë“œ","ì œì´","ì œí‚¤","ì¡°ì´","ì§„","ì§€í¬","ì¹´ì—˜","ì¹´ì´","ì¹¼","ì¼€ì¸","í´ë¼ìš°ë“œ","í‚¤ë¼","í¬ë¦¬ìŠ¤","íƒ€ì´íƒ„","í…Œì˜¤","íŠ¸ë¦¬ìŠ¤","íŒŒë¹„ì•ˆ","íœ","í ë¦­ìŠ¤","í¬ë“œ","í”„ë ˆì´","í•€","í•˜ìš¸","í•œìŠ¤","í—¥í„°","í—¬ê°€","íœ´ê³ "];
const LAST_NAMES = ["ê·¸ë¦°","ê·¸ë ˆì´","ê³¨ë“œ","ë‚˜ì´íŠ¸","ë‹¤í¬","ë¼ì´íŠ¸","ë ˆë“œ","ë¦¬ë²„","ë ˆì¸","ë¬¸","ë¸”ë™","ë¸”ë£¨","ë¸”ë ˆì´ë“œ","ë¸Œë¼ìš´","ìŠ¤ë…¸ìš°","ìŠ¤í†°","ìŠ¤í†¤","ìŠ¤í‹¸","ìŠ¤íƒ€","ì‹¤ë²„","ì• ì‰¬","ì˜¤ì…˜","ìš°ë“œ","ìœˆë“œ","ì›Œí„°","í´ë¼ìš°ë“œ","í”„ë¡œìŠ¤íŠ¸","íŒŒì´ì–´","í™”ì´íŠ¸","í","ê°€ë“œ","ë‚˜ì´íŠ¸","ë“œë¦¬ë¨¸","ë ˆì „ë“œ","ë¡œì—´","ë§ˆìŠ¤í„°","ë©”ì´ì»¤","ë² ì–´","ë³´ìš°","ì‰ë„ìš°","ì„¸ì´ë²„","ì†”ì ¸","ìŠ¤íŠ¸ë¼ì´í¬","ì‹¤ë“œ","ì•„ì´","ìš¸í”„","ì›Œì»¤","ìœ„ìŠ¤í¼","ì²´ì´ì„œ","í¬ë¡œìŠ¤","í‚¹","íŒŒì´í„°","íŒ¬í…€","í­ìŠ¤","í•´ë¨¸","í—Œí„°","í˜¸í¬","í•˜íŠ¸"];

let State = {
    cameraLocked: true,
    p1: { id:'P1', name:'ë‚˜', job:'warrior', subJob:null, pos:0, hp:100, maxHp:100, gold:0, pot:1, exp:0, maxExp:50, lv:1, stats:{move:5, atk:5, def:5, luck:2}, bonus:{moveMin:0,moveMax:0,atkMin:0,atkMax:0,defMin:0,defMax:0,luckMin:0,luckMax:0}, skillCD: 0, equip: { s:null, w:null, a:null, acc:null }, isAi:false, artifacts: [], movedSteps: 0 },
    p2: { id:'P2', name:'ì¶”ê²©ì', pos:0, hp:100, maxHp:100, gold:0, pot:1, stats:{move:5, atk:5, def:5, luck:2}, bonus:{moveMin:0,moveMax:0,atkMin:0,atkMax:0,defMin:0,defMax:0,luckMin:0,luckMax:0}, equip:{s:null, w:null, a:null, acc:null}, isAi:true },
    cards: [], hand: [], summonCnt: 0, slots: {move:null, atk:null, def:null, luck:null},
    turn: 'P1', turnCnt: 1, activeSkillEffect: null, skillUsedTurn: false,
    isMoving: false, isProcessing: false, extraTurn: false, frozen: false,
    monsters: {}, boss: { hp:50, maxHp:50, mn:5, mx:20 }, keyStat: null,
    limitTurn: 0, aiMerged: false, activeSeals: [15, 35] 
};

const Utils = {
    rand: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
    randArr: (arr) => arr[Math.floor(Math.random() * arr.length)],
    wait: (ms) => new Promise(resolve => setTimeout(resolve, ms)),
    floatText: (pos, txt, color) => {
        const tile = document.getElementById(`tile-${pos}`);
        if(!tile) return;
        const el = document.createElement('div');
        el.className = 'float-text'; el.innerText = txt; el.style.color = color;
        tile.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    },
    shake: () => {
        const c = document.getElementById('game-wrapper');
        c.classList.remove('shake-anim'); void c.offsetWidth; c.classList.add('shake-anim');
    },
    flash: () => {
        const c = document.getElementById('game-wrapper');
        c.classList.remove('flash-damage'); void c.offsetWidth; c.classList.add('flash-damage');
    },
    popup: (title, msg, onOk, choices) => {
        const el = document.getElementById('modal-gen');
        const box = document.getElementById('modal-box-gen');
        const t = document.getElementById('m-title');
        const m = document.getElementById('m-msg');
        const c = document.getElementById('m-choices');
        const b = document.getElementById('m-ok');
        box.className = 'modal-box'; 
        t.innerText = title; m.innerHTML = msg; c.innerHTML = '';
        if (choices && choices.length > 0) {
            b.style.display = 'none';
            choices.forEach(ch => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn'; btn.innerHTML = ch.txt;
                btn.onclick = () => { if(ch.act) ch.act(); };
                c.appendChild(btn);
            });
        } else {
            b.style.display = 'block';
            b.onclick = () => { el.style.display = 'none'; if(onOk) onOk(); };
        }
        el.style.display = 'flex';
    },
    centerCamera: (pos) => {
        if (!State.cameraLocked) return;
        const container = document.getElementById('board-container');
        const tile = document.getElementById(`tile-${pos}`);
        if(container && tile) {
            const center = tile.offsetLeft + (tile.offsetWidth / 2) - (container.offsetWidth / 2);
            container.scrollTo({ left: center, behavior: 'smooth' });
        }
    }
};

const Logic = {
    getWeightedItem: () => {
        const r = Math.random() * 100;
        let targetRank = 0;
        if(r < 5) targetRank = 3; else if(r < 20) targetRank = 2; else if(r < 50) targetRank = 1; 
        const pool = ITEMS_DB.filter(i => i.rank === targetRank);
        if(pool.length > 0) return pool[Utils.rand(0, pool.length-1)];
        return ITEMS_DB[Utils.rand(0, ITEMS_DB.length-1)]; 
    },
    equipItem: (p, item) => {
        const slot = item.type;
        const oldItem = p.equip[slot];
        if(!oldItem) {
            p.equip[slot] = item;
            return { type: 'equip', msg: `<span style="color:lime">ì¥ì°© ì™„ë£Œ!</span>` };
        } else {
            if(item.val > oldItem.val) {
                p.equip[slot] = item;
                return { type: 'replace', msg: `<span style="color:cyan">ìƒìœ„ ì¥ë¹„ë¡œ êµì²´!</span><br>(ê¸°ì¡´: ${oldItem.n})` };
            } else {
                const refund = Math.floor(item.cost / 2);
                p.gold += refund;
                return { type: 'sell', msg: `<span style="color:gold">í•˜ìœ„ ì¥ë¹„ íŒë§¤ (+${refund}G)</span>` };
            }
        }
    },
initGame: () => {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        // [ìƒìˆ˜ ì„¤ì •] ì—¬ê¸°ì„œ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ í•œ ë²ˆì— ê´€ë¦¬í•˜ì„¸ìš”!
        const MONSTER_POSITIONS = [5, 9, 13, 17, 22, 27, 31, 35, 40, 45];
        
        // ëª¬ìŠ¤í„° ìˆœì„œë³„ í¬ê¸° (px)
        const monsterSizes = [60, 75, 100, 90, 90, 125, 160, 140, 160, 220];

const animWrap = (key, emoji, size) => {
    return `
        <div class="obj-wrap">
            <img src="${IMG_SRC[key]}" 
                 class="monster-img" 
                 style="width: ${size}px !important; height: ${size}px !important;" 
                 onerror="this.style.display='none';this.parentNode.innerText='${emoji}'">
        </div>`;
};             
        const staticWrap = (key, emoji) => 
            `<div class="static-asset">${getImgTag(key, 'img-asset', emoji)}</div>`;

        // 1. íƒ€ì¼ ë°ì´í„° êµ¬ì¡° ì¤€ë¹„
        let tilesData = new Array(50).fill(null).map(() => ({ cls: '', content: '' }));

        // ---------------------------------------------------------
        // ìš°ì„ ìˆœìœ„ 1: ì‹œì‘, ë, ëª¬ìŠ¤í„° (ìƒìˆ˜ì— ì •ì˜ëœ ìœ„ì¹˜)
        // ---------------------------------------------------------
        tilesData[0] = { cls: 'tile-start', content: 'START' };
        tilesData[49] = { cls: 'tile-end', content: animWrap('boss', 'ğŸ‘¿', 220) };

        // ìƒìˆ˜ì— ì •í•´ì§„ ìœ„ì¹˜ì—ë§Œ ëª¬ìŠ¤í„° ë°°ì¹˜
        MONSTER_POSITIONS.forEach((pos, idx) => {
            if (pos >= 49) return; // ë³´ìŠ¤ ìë¦¬ì™€ ê²¹ì¹¨ ë°©ì§€
            const mName = MONSTERS[Math.min(idx, 9)];
            const s = MON_STATS[Math.min(idx, 9)];
            const mSize = monsterSizes[idx] || 100;

            State.monsters[pos] = { name: mName, mn: s.mn, mx: s.mx };
            tilesData[pos] = { cls: 'tile-monster', content: animWrap(mName, 'ğŸ‘¹', mSize) };
        });

        // ---------------------------------------------------------
        // ìš°ì„ ìˆœìœ„ 2: ì „ì§ì†Œ(1ê°œ)ì™€ ë´‰ì¸ì„(2ê°œ)ì„ ë‚¨ëŠ” ì¹¸ì— ëœë¤ ë°°ì¹˜
        // ---------------------------------------------------------
const JOB_SITE_POS = 25; 
tilesData[JOB_SITE_POS] = { cls: 'tile-job', content: staticWrap('tile_job', 'ğŸ‘‘') };

// 2. ë‚˜ë¨¸ì§€ ë¹ˆ ì¹¸ë“¤ ì¶”ì¶œ (ì „ì§ì†Œ ìë¦¬ëŠ” ì œì™¸ë¨)
let emptyTiles = [];
for (let i = 1; i < 49; i++) {
    // ëª¬ìŠ¤í„°ê°€ ì—†ê³ (contentê°€ ë¹„ì–´ìˆê³ ), ì „ì§ì†Œ ìë¦¬ê°€ ì•„ë‹Œ ê³³ë§Œ ìˆ˜ì§‘
    if (tilesData[i].content === '' && i !== JOB_SITE_POS) {
        emptyTiles.push(i);
    }
}
emptyTiles.sort(() => Math.random() - 0.5);

// 3. ë´‰ì¸ì„ ëœë¤ ë°°ì¹˜ (ë‚¨ì€ ë¹ˆ ì¹¸ ì¤‘ 2ê°œ)
for (let j = 0; j < 2; j++) {
    if (emptyTiles.length > 0) {
        let idx = emptyTiles.pop();
        tilesData[idx] = { cls: 'tile-seal', content: staticWrap('tile_seal', 'ğŸ’') };
    }
}
        // ---------------------------------------------------------
        // ìš°ì„ ìˆœìœ„ 3: ë‚˜ë¨¸ì§€ ë¹ˆ ì¹¸ì— ì´ë²¤íŠ¸/ì¥í•´ë¬¼ ë°°ì¹˜
        // ---------------------------------------------------------
        for (let i = 0; i < 50; i++) {
            if (tilesData[i].content === '') {
                let r = Math.random();
                if (r < 0.1) tilesData[i] = { cls: 'tile-fire', content: staticWrap('tile_fire', 'ğŸ”¥') };
                else if (r < 0.18) tilesData[i] = { cls: 'tile-ice', content: staticWrap('tile_ice', 'â„ï¸') };
                else if (r < 0.25) tilesData[i] = { cls: 'tile-heal', content: staticWrap('tile_heal', 'ğŸ’§') };
                else if (r < 0.35) tilesData[i] = { cls: 'tile-event', content: staticWrap('tile_event', '?') };
            }
        }

        // ìµœì¢… ê·¸ë¦¬ë“œ ìƒì„±
        for (let i = 0; i < 50; i++) {
            const d = document.createElement('div');
            d.className = `tile ${tilesData[i].cls}`;
            d.id = `tile-${i}`;
            d.innerHTML = tilesData[i].content;
            grid.appendChild(d);
        }
        UI.update();
const p2El = document.createElement('div'); 
p2El.id = 'pawn-p2'; p2El.className = 'pawn p2';
grid.appendChild(p2El);
        Logic.startTurn();
    },
    getStats: (p) => {
        const s = p.stats, b = p.bonus, e = p.equip;
        const sVal = e.s ? e.s.val : 0;
        const wVal = e.w ? e.w.val : 0;
        const aVal = e.a ? e.a.val : 0;
        const accVal = e.acc ? e.acc.val : 0;
        let atkBon = wVal, defBon = aVal, luckBon = 0, moveBon = sVal;
        if(e.acc) {
            if(e.acc.desc.includes("ìš´")) luckBon = accVal;
            if(e.acc.desc.includes("ì´ë™")) moveBon += accVal;
        }
        if(p.id==='P1' && Logic.hasArt('boots')) moveBon += 1;
        if(p.id==='P1' && Logic.hasArt('lucky')) luckBon += 2;
        if(p.id==='P1' && Logic.hasArt('glass')) atkBon += 5;
        let minMove = 1 + b.moveMin;
        if(p.subJob && p.subJob.id === 'pathfinder') minMove = Math.max(4, minMove);
        return {
            mvMin: minMove, mvMax: Math.max(1, s.move + b.moveMax + moveBon),
            atMin: 1 + b.atkMin, atMax: Math.max(1, s.atk + b.atkMax + atkBon),
            dfMin: 1 + b.defMin, dfMax: Math.max(1, s.def + b.defMax + defBon),
            lkMin: 0 + b.luckMin, lkMax: Math.max(0, s.luck + b.luckMax + luckBon)
        };
    },
    applyUpgrade: (p, type, isMax, silent=false) => {
        const key = type + (isMax ? 'Max' : 'Min');
        p.bonus[key]++;
        UI.update();
        if(!p.isAi && !silent) {
            const map = {move:'ì´ë™', atk:'ê³µê²©', def:'ë°©ì–´', luck:'ìš´'};
            Utils.popup("ëŠ¥ë ¥ì¹˜ ìƒìŠ¹", `${map[type]} ${isMax?'ìµœëŒ€':'ìµœì†Œ'} +1 ì¦ê°€!`, null);
        }
    },
    handleDeath: (p) => {
        if (p.hp <= 0) {
            p.hp = p.maxHp; p.pos = 0;
            p.gold = Math.floor(p.gold / 2);
            Utils.floatText(0, "ğŸš‘ êµ¬ì¡°ë¨", "lime");
            UI.update(); return true; 
        }
        return false; 
    },
    hasArt: (id) => State.p1.artifacts.some(a => a.id === id),
    startTurn: () => {
        State.isMoving = false; State.isProcessing = false; State.activeSkillEffect = null;
        if (State.limitTurn > 0) {
            State.limitTurn--;
            const timerEl = document.getElementById('doom-timer');
            timerEl.style.display = 'block'; timerEl.innerText = `BOSS D-DAY: ${State.limitTurn}`;
            if(State.limitTurn <= 0) { Logic.endGame(false); return; }
        }
        if(State.boss.hp > 0 && State.boss.hp < State.boss.maxHp) State.boss.hp++;
        if (State.aiMerged && State.turn === 'P2') State.turn = 'P1'; 
        const ind = document.getElementById('turn-msg');
        document.getElementById('hud-p1').classList.remove('active-turn');
        document.getElementById('hud-p2').classList.remove('active-turn');
        if(State.turn === 'P1') {
            const p1 = State.p1;
            Utils.centerCamera(p1.pos);
            if(!State.extraTurn) {
                State.turnCnt++; if(p1.skillCD > 0) p1.skillCD--;
                if(p1.subJob && p1.subJob.id === 'paladin') {
                    p1.hp = Math.min(p1.maxHp, p1.hp + Math.floor(p1.maxHp * 0.1));
                    Utils.floatText(p1.pos, "ì„±ìŠ¤ëŸ¬ìš´ ë¹›", "yellow");
                }
                let g = Utils.rand(1, 10);
                if(Logic.hasArt('greed')) g *= 2; 
                p1.gold += g; Utils.floatText(p1.pos, `+${g}G`, "gold");
            }
            State.skillUsedTurn = false;
            if(State.frozen) { Utils.floatText(p1.pos, "â„ï¸ë™ìƒ", "cyan"); State.frozen=false; }
            document.getElementById('hud-p1').classList.add('active-turn');
            ind.innerText = State.extraTurn ? "ì—°ì† í–‰ë™ ê¸°íšŒ!" : `í„´ ${State.turnCnt}: ë‹¹ì‹ ì˜ ì°¨ë¡€`;
            ind.style.color = '#4CAF50';
            document.getElementById('btn-roll').disabled = false;
            const bSk = document.getElementById('btn-skill');
            bSk.classList.remove('active', 'passive');
            if(p1.subJob) {
                const isAct = p1.subJob.type === 'active';
                const color = isAct ? "#fff" : "#888";
                bSk.innerHTML = `<span style="font-size:10px; color:${color}">[${isAct?'ì•¡í‹°ë¸Œ':'íŒ¨ì‹œë¸Œ'}]</span><br>${p1.subJob.sn}`;
                if(isAct && p1.skillCD > 0) bSk.innerHTML += `<br><span style="color:red; font-size:10px">ì¿¨íƒ€ì„ (${p1.skillCD})</span>`;
                else if(!isAct) bSk.classList.add('passive');
                bSk.disabled = false; 
            } else {
                bSk.innerHTML = "<span style='font-size:10px; color:#aaa'>ë¯¸ê°œë°©</span><br>ìŠ¤í‚¬";
                bSk.disabled = true;
            }
        } else {
            document.getElementById('hud-p2').classList.add('active-turn');
            ind.innerText = State.extraTurn ? "ì¶”ê²©ì ì—°ì† í–‰ë™!" : `í„´ ${State.turnCnt}: ì¶”ê²©ì í„´`;
            ind.style.color = '#FF5722';
            document.getElementById('btn-roll').disabled = true;
            document.getElementById('btn-skill').disabled = true;
            if(!State.extraTurn) State.p2.gold += Utils.rand(1,10);
            State.isProcessing = true;
            setTimeout(Logic.aiTurn, 500); 
        }
        State.extraTurn = false;
        UI.update();
    },
    aiTurn: async () => {
        try {
            await Utils.wait(500); const p = State.p2;
            if(!State.aiMerged) Utils.centerCamera(p.pos);
            if (p.hp < p.maxHp * 0.3 && p.pot > 0) {
                p.pot--; p.hp = Math.min(p.maxHp, p.hp + 50);
                Utils.floatText(p.pos, "+50HP", "cyan"); await Utils.wait(800);
            } else if (p.gold >= 150 && Math.random() < 0.6) {
                const item = ITEMS_DB[Utils.rand(0, ITEMS_DB.length-1)];
                if(p.gold >= item.cost) {
                    p.gold -= item.cost; p.equip[item.type] = item;
                    Utils.floatText(p.pos, `êµ¬ë§¤: ${item.n}`, "cyan"); await Utils.wait(800);
                }
            } else if (p.gold >= 100) { 
                p.gold -= 100; Logic.applyUpgrade(p, ['move','atk','def','luck'][Utils.rand(0,3)], Math.random()<0.5, true); 
                Utils.floatText(p.pos, "ê°•í™”ì™„ë£Œ", "cyan"); await Utils.wait(800);
            }
        } catch(e) { console.error("AI Error", e); } 
        finally { UI.update(); Game.roll(true); }
    },
    moveStep: async (p, steps) => {
        if(p.id==='P1' && State.frozen) steps = Math.max(1, Math.floor(steps/2));
        if(p.subJob && p.subJob.id === 'ranger') p.movedSteps = steps; else p.movedSteps = 0;
        for(let i=0; i<steps; i++) {
            if(p.pos >= 49) break;
            p.pos++; Utils.centerCamera(p.pos); UI.update(); await Utils.wait(250);
            if(State.activeSeals.includes(p.pos)) { await Logic.sealEvent(p); continue; }
            if(p.pos === 25 && p.id === 'P1') { await Logic.jobEvent(p); continue; }
            if(State.monsters[p.pos]) return Logic.battle(p, null, () => Logic.endTurn());
            const opp = p.id==='P1' ? State.p2 : State.p1;
            if(p.pos === opp.pos && p.pos !== 0 && p.pos !== 49 && !State.aiMerged) return Logic.battle(p, opp, () => Logic.endTurn());
        }
        if(p.pos === 49) {
            if(p.isAi) { Logic.aiPowerUpBoss(); return; } 
            else { return Logic.battle(p, null, () => Logic.endTurn(), true); }
        }
        const tile = document.getElementById(`tile-${p.pos}`);
        if(tile.classList.contains('tile-fire')) {
            p.hp -= 10; Utils.flash(); Utils.floatText(p.pos, "ğŸ”¥-10HP", "orange");
            if (Logic.handleDeath(p)) { return Logic.endTurn(); }
        } else if(tile.classList.contains('tile-ice')) {
            Utils.floatText(p.pos, "â„ï¸ì˜¤í•œ..", "cyan"); if(p.id==='P1') State.frozen = true;
        } else if(tile.classList.contains('tile-heal')) {
            p.hp = Math.min(p.maxHp, p.hp + 15); Utils.floatText(p.pos, "ğŸ’§+15HP", "lime"); UI.update();
        }
        if(!tile.classList.contains('tile-monster') && !tile.classList.contains('tile-start') && p.pos !== 49 && !State.activeSeals.includes(p.pos) && p.pos !== 25) {
            await Logic.event(p);
        } else { Logic.endTurn(); }
    },
    sealEvent: (p) => {
        return new Promise(resolve => {
            const tile = document.getElementById(`tile-${p.pos}`);
            tile.className = 'tile'; tile.innerHTML = ''; 
            State.activeSeals = State.activeSeals.filter(s => s !== p.pos);
            if(p.isAi) {
                State.boss.maxHp += 10; State.boss.hp += 10;
                State.boss.mn += 2; State.boss.mx += 2;
                Utils.floatText(p.pos, "ë´‰ì¸íŒŒê´´(ë³´ìŠ¤ê°•í™”)", "red"); setTimeout(resolve, 800);
            } else {
                State.boss.hp = Math.floor(State.boss.hp * 0.8);
                const art = ARTIFACTS[Utils.rand(0, ARTIFACTS.length-1)];
                if(!State.p1.artifacts.find(a=>a.id===art.id)) State.p1.artifacts.push(art);
                Utils.popup("ë´‰ì¸ í•´ì œ!", `ë´‰ì¸ì„ì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë§ˆì™•ì˜ í˜ì´ ì•½í•´ì§‘ë‹ˆë‹¤. (-20% HP)<br><br>ìœ ë¬¼ ë°œê²¬: <b style="color:gold;">${art.n}</b><br><span style="color:#aaa">${art.desc}</span>`, resolve);
            }
        });
    },
    jobEvent: (p) => {
        return new Promise(resolve => {
            if(p.subJob) { resolve(); return; } 
            const choices = []; const jobs = JOBS[p.job];
            jobs.forEach(j => {
                choices.push({
                    txt: `<div style="font-size:18px">${j.i} ${j.n} <span style="font-size:14px;color:gold">(${j.sn})</span></div><div style="font-size:12px;color:#aaa">${j.desc}</div>`,
                    act: () => {
                        p.subJob = j; p.maxHp += 20; p.hp = p.maxHp;
                        p.bonus.atkMax += 2; p.bonus.defMax += 2;
                        if(j.id === 'alchemist') p.pot += 2;
                        const bSk = document.getElementById('btn-skill');
                        const isAct = j.type === 'active';
                        bSk.innerHTML = `<span style="font-size:10px; color:${isAct?'#fff':'#888'}">[${isAct?'ì•¡í‹°ë¸Œ':'íŒ¨ì‹œë¸Œ'}]</span><br>${j.sn}`;
                        bSk.disabled = false; 
                        UI.update();
                        Utils.popup("ì „ì§ ì™„ë£Œ!", `${j.n}ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ìŠ¤í‚¬ íšë“: <b style="color:gold">${j.sn}</b><br>ì²´ë ¥íšŒë³µ, MaxHP+20, ê³µë°©+2`, resolve);
                    }
                });
            });
            Utils.popup("ğŸ‘‘ ì „ì§ê´€", "ìƒˆë¡œìš´ í˜ì„ ì–»ì„ ë•Œê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. (ì „ì§ ì‹œ ìƒì„¸ ëŠ¥ë ¥ í™•ì¸)", null, choices);
        });
    },
    aiPowerUpBoss: () => {
        State.aiMerged = true; State.p2.hp = 0; State.boss.hp *= 2;
        State.boss.mn *= 2; State.boss.mx *= 2; State.limitTurn = 6; UI.update();
        Utils.popup("âš ï¸ ê²½ê³ ", "ì¶”ê²©ìê°€ ë§ˆì™•ì—ê²Œ ì˜í˜¼ì„ ë°”ì³¤ìŠµë‹ˆë‹¤!<br>ë§ˆì™•ì´ ê°•ë ¥í•´ì¡ŒìŠµë‹ˆë‹¤.<br><b style='color:red'>5í„´ ì•ˆì— ë§ˆì™•ì„ ì²˜ì¹˜í•˜ì„¸ìš”!</b>", () => Logic.endTurn());
    },
    event: (p) => {
        return new Promise(resolve => {
            const finish = () => { UI.update(); resolve(); Logic.endTurn(); };
            const applyRandomStat = () => {
                const types = ['move','atk','def','luck'];
                const type = types[Utils.rand(0, 3)];
                const val = Utils.rand(-1, 3);
                const typeName = {move:'ì´ë™', atk:'ê³µê²©', def:'ë°©ì–´', luck:'ìš´'}[type];
                if (val >= 0) {
                    p.bonus[type + 'Max'] += val;
                    if(val > 1 && type !== 'luck') p.bonus[type + 'Min'] += 1; 
                    return `<span style="color:${val===3?'gold':'lime'}">${typeName} +${val}</span>`;
                } else {
                    p.bonus[type + 'Max'] = Math.max(0, p.bonus[type + 'Max'] + val);
                    return `<span style="color:red">${typeName} ${val}</span>`;
                }
            };
            if(p.isAi) {
                Logic.applyUpgrade(p, ['move','atk','def','luck'][Utils.rand(0,3)], true, true);
                Utils.floatText(p.pos, "ì´ë²¤íŠ¸", "cyan"); setTimeout(finish, 800);
            } else {
                const evType = Utils.rand(0, 1); 
                if(evType === 0) {
                    Utils.popup("ì˜¤ë˜ëœ ìƒì", "ë¨¼ì§€ê°€ ìŒ“ì¸ ìƒìì…ë‹ˆë‹¤. ë¬´ì—‡ì´ ë“¤ì—ˆì„ê¹Œìš”?", null, [
                        {txt:"ì—°ë‹¤ (ì¥ë¹„ or ëœë¤ëŠ¥ë ¥)", act:()=>{
                            const r = Math.random();
                            if(r < 0.4) { 
                                const item = Logic.getWeightedItem();
                                const res = Logic.equipItem(p, item);
                                const rankName = ["ì¼ë°˜","í¬ê·€","ì˜ì›…","ì „ì„¤"][item.rank];
                                const rankColor = ["#ccc","#448aff","#b388ff","gold"][item.rank];
                                Utils.popup("ì•„ì´í…œ íšë“!", `[<span style="color:${rankColor}">${rankName}</span>] <b>${item.n}</b><br><span style="color:#aaa">${item.desc}</span><br><br>${res.msg}`, finish);
                            } else { 
                                const resultMsg = applyRandomStat();
                                Utils.popup("ìƒìì˜ ê¸°ìš´", `ìƒìì—ì„œ ê¸°ì´í•œ ì—°ê¸°ê°€ í”¼ì–´ì˜¤ë¦…ë‹ˆë‹¤.<br><br><b>${resultMsg}</b>`, finish);
                            }
                        }},
                        {txt:"ë¬´ì‹œí•œë‹¤", act: finish}
                    ]);
                } else {
                    Utils.popup("ìˆ˜ìƒí•œ ìƒ˜ë¬¼", "ë§ˆë ¥ì´ ëŠê»´ì§€ëŠ” ìƒ˜ë¬¼ì…ë‹ˆë‹¤.\n(ëŠ¥ë ¥ì¹˜ê°€ ë³€ë™ë©ë‹ˆë‹¤: -1 ~ +3)", null, [
                        {txt:"ë§ˆì‹ ë‹¤", act:()=>{
                            const res1 = applyRandomStat();
                            const res2 = applyRandomStat(); 
                            Utils.popup("ê¿€êº½", `ëª¸ì— ë³€í™”ê°€ ìƒê¹ë‹ˆë‹¤!<br>${res1}<br>${res2}`, finish);
                        }},
                        {txt:"ì§€ë‚˜ê°„ë‹¤", act: finish}
                    ]);
                }
            }
        });
    },
    battle: (atk, def, callback, isBoss=false) => {
        const isPvP = !!def;
        const name = isBoss ? "ë§ˆì™•" : (isPvP ? (def.id==='P2'?"ì¶”ê²©ì":"ë‚˜") : State.monsters[atk.pos].name);
        const sAtk = Logic.getStats(atk);
        let dfMin=0, dfMax=0, hpCur=0, hpMax=0;
        let enAtkStr = "-"; 
        let enemyImgKey = ''; let needFlip = false;

        if(isBoss) { 
            dfMin = State.boss.mn; dfMax = State.boss.mx; 
            hpCur = State.boss.hp; hpMax = State.boss.maxHp; 
            enAtkStr = `${State.boss.mn}~${State.boss.mx}`; 
            enemyImgKey = 'boss';
        } else if(isPvP) {
            const sDef = Logic.getStats(def); 
            dfMin = sDef.dfMin; dfMax = sDef.dfMax; 
            hpCur = def.hp; hpMax = def.maxHp;
            enAtkStr = `${sDef.atMin}~${sDef.atMax}`;
            if (def.id === 'P1') { enemyImgKey = def.subJob||def.job; needFlip = true; } 
            else { enemyImgKey = 'enemy'; needFlip = true; } 
        } else {
            const m = State.monsters[atk.pos]; 
            dfMin = m.mn; dfMax = m.mx; 
            hpCur = 100; hpMax = 100; 
            enAtkStr = "-"; 
            enemyImgKey = m.name; 
            needFlip = false;
        }

        let p1ImgKey = (atk.id === 'P1') ? (atk.subJob ? atk.subJob.id : atk.job) : 'enemy';

        const previewHtml = `
            <div class="battle-preview-wrap">
                <div class="preview-card">
                    <div class="p-img-box">${getImgTag(p1ImgKey, 'img-asset')}</div>
                    <div style="color:lime; font-weight:bold; font-size:18px; margin-bottom:5px;">${atk.name}</div>
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">â¤ï¸HP</span> <span class="stat-val" style="color:#ff8a80">${atk.hp}/${atk.maxHp}</span></div>
                        <div class="stat-row"><span class="stat-label">âš”ï¸ê³µ</span> <span class="stat-val" style="color:#80d8ff">${sAtk.atMin}~${sAtk.atMax}</span></div>
                        <div class="stat-row"><span class="stat-label">ğŸ›¡ï¸ë°©</span> <span class="stat-val" style="color:#b9f6ca">${sAtk.dfMin}~${sAtk.dfMax}</span></div>
                        <div class="stat-row"><span class="stat-label">ğŸ€ìš´</span> <span class="stat-val" style="color:gold">${sAtk.lkMin}~${sAtk.lkMax}</span></div>
                    </div>
                </div>
                <div class="preview-card vs">VS</div>
                <div class="preview-card">
                    <div class="p-img-box ${needFlip?'preview-flip':''}">${getImgTag(enemyImgKey, 'img-asset', 'ğŸ‘¹')}</div>
                    <div style="color:red; font-weight:bold; font-size:18px; margin-bottom:5px;">${name}</div>
                    <div class="stat-box">
                        <div class="stat-row"><span class="stat-label">â¤ï¸HP</span> <span class="stat-val" style="color:#ff8a80">${hpCur}/${hpMax}</span></div>
                        <div class="stat-row"><span class="stat-label">âš”ï¸ê³µ</span> <span class="stat-val" style="color:#80d8ff">${enAtkStr}</span></div> 
                        <div class="stat-row"><span class="stat-label">ğŸ›¡ï¸ë°©</span> <span class="stat-val" style="color:#b9f6ca">${dfMin}~${dfMax}</span></div>
                    </div>
                </div>
            </div>
            <div style="text-align:center; color:#888; font-size:14px; margin-top:5px;">
                ${atk.isAi ? "ğŸ¤– AIê°€ ì „ìˆ  ì—°ì‚° ì¤‘..." : "ìƒëŒ€ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ì „íˆ¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”."}
            </div>
        `;

        const runCombat = () => {
            let combatLog = [];
            let aMin = sAtk.atMin, aMax = sAtk.atMax;
            let lkMin = sAtk.lkMin, lkMax = sAtk.lkMax;

            if(atk.id==='P1' && atk.subJob && atk.subJob.id === 'assassin') {
                const luckBonus = sAtk.lkMax * 2; aMin += luckBonus; aMax += luckBonus;
                combatLog.push(`ê¸‰ì†Œ ê°€ê²©: ìš´x2 ê³µê²©ë ¥(${luckBonus}) ì¶”ê°€`);
            }
            if(atk.id==='P1' && atk.subJob && atk.subJob.id === 'ranger') {
                aMin += atk.movedSteps; aMax += atk.movedSteps;
                combatLog.push(`ë°”ëŒì˜ ì‚¬ê²©: ê±°ë¦¬(${atk.movedSteps}) ë°ë¯¸ì§€ ì¶”ê°€`);
            }
            if(atk.id==='P1') {
                if(State.activeSkillEffect === 'fireball') { 
                    aMin=20; aMax=20; combatLog.push("ë©”í…Œì˜¤: ê³ ì • í”¼í•´ 20");
                } 
                if(atk.subJob && atk.subJob.id === 'berserker' && atk.hp > 25) {
                    atk.hp -= 25; aMin *= 2; aMax *= 2; 
                    combatLog.push("í”¼ì˜ ê²©ë…¸: HP 25 ì†Œëª¨, ê³µê²©ë ¥ 2ë°°");
                }
                if(atk.subJob && atk.subJob.id === 'warlock' && atk.gold >= 50) {
                    atk.gold -= 50; aMin += 15; aMax += 15;
                    combatLog.push("ì˜í˜¼ ì°©ì·¨: ê³¨ë“œ ì†Œëª¨, í”¼í•´ +15");
                }
            }

            const battleSceneHtml = `
            <div class="battle-scene" id="battle-scene">
                <div class="battler-wrap p1-side">${getImgTag(p1ImgKey, 'battler-img', 'âš”ï¸')}</div>
                <div style="font-weight:bold; color:#777; font-size:24px;">VS</div>
                <div class="battler-wrap enemy-side ${needFlip ? 'battler-flip' : ''}">${getImgTag(enemyImgKey, 'battler-img', 'ğŸ‘¹')}</div>
            </div>`;

            const hpP1Start = atk.hp; const hpP1Max = atk.maxHp;
            let hpTargetStart = isBoss ? State.boss.hp : (isPvP ? def.hp : 100);
            let hpTargetMax = isBoss ? State.boss.maxHp : (isPvP ? def.maxHp : 100);

            const visualHtml = `
            <div class="battle-visual-row">
                <div class="bv-side">
                    <div class="bv-name">${atk.name}</div>
                    <div class="bv-bar-bg"><div id="bv-p1" class="bv-bar-fill p1-bv-fill" style="width:${(hpP1Start/hpP1Max)*100}%"></div><div id="bv-txt-p1" class="bv-bar-txt">${hpP1Start}</div></div>
                </div>
                <div class="bv-side">
                    <div class="bv-name">${name}</div>
                    <div class="bv-bar-bg"><div id="bv-enemy" class="bv-bar-fill enemy-bv-fill" style="width:${(isBoss || isPvP) ? (hpTargetStart/hpTargetMax)*100 : 100}%"></div><div id="bv-txt-enemy" class="bv-bar-txt">${isBoss||isPvP ? hpTargetStart : '?'}</div></div>
                </div>
            </div>`;

            document.getElementById('m-msg').innerHTML = `${battleSceneHtml}${visualHtml}<div style="color:orange; font-weight:bold; animation:pulse 1s infinite">âš”ï¸ ê²©ëŒ ì¤‘...</div>`;
            document.getElementById('m-choices').innerHTML = ''; 

            setTimeout(() => {
                try {
                    let rAtk = Utils.rand(aMin, aMax); let rLuck = Utils.rand(lkMin, lkMax);
                    let totalAtk = rAtk + rLuck;
                    if(atk.id==='P1' && State.activeSkillEffect === 'fireball') totalAtk = 20;

                    let rDef = Utils.rand(dfMin, dfMax);
                    let rDLuck = isPvP ? Utils.rand(Logic.getStats(def).lkMin, Logic.getStats(def).lkMax) : 0;
                    let totalDef = rDef + rDLuck;

                    if(def && def.id === 'P1') {
                        if(Logic.hasArt('glass')) { totalDef -= 5; combatLog.push("ìœ ë¦¬ëŒ€í¬: ë°›ëŠ” í”¼í•´ +5"); }
                    }
                    if(atk.id==='P1' && atk.subJob && atk.subJob.id === 'sniper') {
                        totalDef = Math.floor(totalDef * 0.5); combatLog.push("ì•½ì  í¬ì°©: ë°©ì–´ë ¥ 50% ê´€í†µ");
                    }

                    let win = totalAtk >= totalDef;
                    if(!win && def && def.id === 'P1' && def.subJob && def.subJob.id === 'phantom') {
                        if(Math.random() < 0.3) { win = false; totalAtk = 0; Utils.floatText(def.pos, "íšŒí”¼!", "cyan"); combatLog.push("ê·¸ë¦¼ì ë§í† : ì™„ì „ íšŒí”¼!"); }
                    }

                    const p1Img = document.querySelector('.p1-side .battler-img');
                    const enImg = document.querySelector('.enemy-side .battler-img');
                    if(p1Img && enImg) {
                        p1Img.classList.add('atk-anim-p1');
                        setTimeout(() => p1Img.classList.remove('atk-anim-p1'), 300);
                        if(win) setTimeout(() => { enImg.classList.add('hit-anim'); setTimeout(() => enImg.classList.remove('hit-anim'), 400); }, 200);
                        else setTimeout(() => { enImg.classList.add('atk-anim-enemy'); setTimeout(() => enImg.classList.remove('atk-anim-enemy'), 300); setTimeout(() => { p1Img.classList.add('hit-anim'); setTimeout(() => p1Img.classList.remove('hit-anim'), 400); }, 200); }, 400);
                    }
                    Utils.shake();

                    let log = `ê³µê²©: <b>${totalAtk}</b> vs ë°©ì–´: <b>${totalDef}</b>`;
                    let bossDead = false;

                    if(isBoss) {
                        State.boss.hp -= totalAtk;
                        Utils.floatText(49, `-${totalAtk}HP`, "red");
                        let bossAtkVal = Utils.rand(State.boss.mn, State.boss.mx);
                        let playerDefVal = Utils.rand(Logic.getStats(atk).dfMin, Logic.getStats(atk).dfMax);
                        let bossDmg = Math.max(0, bossAtkVal - playerDefVal);
                        if(atk.id==='P1' && atk.subJob && atk.subJob.id === 'guardian') { bossDmg = Math.max(0, bossDmg - 3); combatLog.push("ì² ë²½ ë°©ì–´: í”¼í•´ ê°ì†Œ"); }
                        atk.hp -= bossDmg;
                        Utils.flash(); Utils.floatText(atk.pos, `-${bossDmg}HP`, "red");
                        log += `<br>ë§ˆì™• ë°˜ê²©! (ê³µ${bossAtkVal} vs ë°©${playerDefVal}) <span style="color:red">-${bossDmg}HP</span>`;
                        if(def && def.id==='P1' && def.subJob && def.subJob.id === 'avenger') { State.boss.hp -= totalDef; Utils.floatText(49, `-${totalDef}HP(ë°˜ì‚¬)`, "yellow"); }
                        if(State.boss.hp <= 0) { State.boss.hp=0; bossDead=true; }
                    } else {
                        if(win) {
                            if(isPvP) { def.hp -= totalAtk; Utils.floatText(def.pos, `-${totalAtk}HP`, "red"); }
                            let recoil = Math.floor(totalDef * 0.5);
                            if(atk.id==='P1' && atk.subJob && atk.subJob.id === 'guardian') { recoil = Math.max(0, recoil - 3); if(recoil < Math.floor(totalDef*0.5)) combatLog.push("ì² ë²½ ë°©ì–´: ë°˜ë™ ê°ì†Œ"); }
                            if(recoil > 0) { atk.hp -= recoil; Utils.flash(); log += `<br><span style="color:orange">ìŠ¹ë¦¬! (ë°˜ë™ -${recoil}HP)</span>`; }
                            else { log += `<br><span style="color:lime">ì™„ë²½í•œ ìŠ¹ë¦¬!</span>`; }
                        } else {
                            let recoil = Math.max(1, totalDef - totalAtk);
                            if(atk.id==='P1' && atk.subJob && atk.subJob.id === 'guardian') recoil = Math.max(0, recoil - 3);
                            atk.hp -= recoil; Utils.flash(); Utils.floatText(atk.pos, `-${recoil}HP`, "red");
                            if(def && def.id==='P1' && Logic.hasArt('thorn')) { atk.hp -= 5; log += "<br>ê°€ì‹œê°‘ì˜· ë°˜ì‚¬! (-5)"; }
                            log += `<br><span style="color:red">íŒ¨ë°°.. -${recoil} HP</span>`;
                        }
                    }

                    if(atk.id==='P1' && Logic.hasArt('vamp')) { atk.hp += 5; Utils.floatText(atk.pos, "+5HP", "pink"); }

                    if(win && !isBoss && !isPvP) {
                        delete State.monsters[atk.pos];
                        const tile = document.getElementById(`tile-${atk.pos}`); if(tile) { tile.className='tile'; tile.innerHTML=''; }
                        const g = Utils.rand(30,60); atk.gold+=g; if(!atk.isAi) Utils.floatText(atk.pos, `+${g}G`, "gold");
                        if(atk.id==='P1') Logic.checkLv(); else Logic.applyUpgrade(atk, ['move','atk','def','luck'][Utils.rand(0,3)], Math.random()<0.5, true);
                    } else if(win && isPvP) {
                        const push = Math.max(1, totalAtk - totalDef); def.pos = Math.max(0, def.pos - push); State.extraTurn = true; log += "<br>ìƒëŒ€ ë°€ì³ëƒ„! ì—°ì† í–‰ë™!";
                    } else if(!win) {
                        const push = Math.max(1, totalDef - totalAtk); atk.pos = Math.max(0, atk.pos - push); log += "<br>ê³µê²© ì‹¤íŒ¨! ë°€ë ¤ë‚¨!";
                    }

                    if (Logic.handleDeath(atk)) { log += "<br><b style='color:red'>ê¸°ì ˆ! êµ¬ì¡°ë˜ì—ˆìŠµë‹ˆë‹¤.</b>"; State.extraTurn = false; }
                    UI.update();

                    const p1Bar = document.getElementById('bv-p1'); const p1Txt = document.getElementById('bv-txt-p1');
                    if(p1Bar) { 
                        const finalP1Hp = atk.hp; const finalP1Pct = (finalP1Hp / atk.maxHp) * 100; 
                        if(finalP1Hp < hpP1Start) p1Bar.classList.add('hit'); 
                        p1Bar.style.width = `${Math.max(0, finalP1Pct)}%`; p1Txt.innerText = finalP1Hp; 
                    }
                    const enBar = document.getElementById('bv-enemy'); const enTxt = document.getElementById('bv-txt-enemy');
                    if(enBar) { 
                        let finalEnHp = isBoss?State.boss.hp : (isPvP?def.hp : (win?0:100)); 
                        let finalEnMax = isBoss?State.boss.maxHp : (isPvP?def.maxHp : 100);
                        const finalEnPct = (finalEnHp / finalEnMax) * 100; 
                        if(finalEnHp < hpTargetStart) enBar.classList.add('hit'); 
                        enBar.style.width = `${Math.max(0, finalEnPct)}%`; enTxt.innerText = (isBoss||isPvP)?finalEnHp:(win?'DEAD':'?'); 
                    }

                    let detailLog = ""; if(combatLog.length > 0) detailLog = `<div style="margin-top:5px; font-size:11px; color:gold; border-top:1px solid #555; padding-top:5px;">[ì „íˆ¬ ìƒì„¸]<br>${combatLog.join('<br>')}</div>`;
                    const resultHtml = `<div style="border:2px solid ${win?'lime':'red'}; padding:10px; border-radius:8px; background:rgba(0,0,0,0.5); margin-bottom:10px;"><div style="font-size:24px; font-weight:bold; color:${win?'lime':'red'}">${win?"WIN!":"LOSE.."}</div><div style="font-size:12px; color:#ddd; margin-top:5px;">${log}</div>${detailLog}</div>`;

                    const msgContainer = document.getElementById('m-msg');
                    const battleSceneDiv = msgContainer.querySelector('.battle-scene');
                    const visualDiv = msgContainer.querySelector('.battle-visual-row');
                    msgContainer.innerHTML = '';
                    if(battleSceneDiv) msgContainer.appendChild(battleSceneDiv);
                    if(visualDiv) msgContainer.appendChild(visualDiv);
                    msgContainer.innerHTML += resultHtml;

                    if (atk.isAi) {
                        setTimeout(() => {
                            document.getElementById('modal-gen').style.display='none';
                            if(bossDead) Logic.endGame(true); else callback();
                        }, 2000);
                    } else {
                        const btn = document.getElementById('m-ok');
                        btn.style.display = 'block';
                        btn.innerText = 'í™•ì¸'; 
                        btn.onclick = () => {
                            document.getElementById('modal-gen').style.display='none';
                            if(bossDead) Logic.endGame(true); else callback();
                        };
                    }

                } catch(e) { console.error(e); document.getElementById('modal-gen').style.display='none'; callback(); }
            }, 1200);
        };

        if (atk.isAi) {
            Utils.popup(isBoss?"â˜ ï¸ ë³´ìŠ¤ì „":(isPvP?"âš”ï¸ PVP":"ğŸ‘¹ ëª¬ìŠ¤í„° ë°œê²¬"), previewHtml, null, []);
            setTimeout(runCombat, 3000);
        } else {
            Utils.popup(isBoss?"â˜ ï¸ ë³´ìŠ¤ì „":(isPvP?"âš”ï¸ PVP":"ğŸ‘¹ ëª¬ìŠ¤í„° ë°œê²¬"), previewHtml, null, [
                { txt: "âš”ï¸ ì „íˆ¬ ì‹œì‘", act: runCombat }
            ]);
        }

        if(isBoss) document.getElementById('modal-box-gen').classList.add('boss-theme');
        else document.getElementById('modal-box-gen').classList.remove('boss-theme');
    },
    checkLv: () => {},
    endTurn: () => {
        document.getElementById('modal-gen').style.display='none';
        State.isMoving = false;
        State.isProcessing = false;
        if(State.extraTurn) {
            Utils.floatText(State[State.turn.toLowerCase()].pos, "ì—°ì† í–‰ë™!", "lime");
            Logic.startTurn();
        } else {
            State.turn = State.turn === 'P1' ? 'P2' : 'P1';
            Logic.startTurn();
        }
    },
    endGame: (win) => {
        const scr = document.getElementById('modal-end');
        const tit = document.getElementById('end-title');
        const con = document.getElementById('end-content');
        scr.style.display = 'flex';
        if(win) {
            tit.innerText = "VICTORY"; tit.style.color = "lime";
            const score = State.p1.gold + (State.turnCnt*10) + State.p1.hp;
            con.innerHTML = `ë§ˆì™•ì„ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤!<br>ìµœì¢… ì ìˆ˜: <span style="color:gold">${score}ì </span>`;
        } else {
            tit.innerText = "GAME OVER"; tit.style.color = "red";
            con.innerHTML = "ì‹œê°„ì´ ì´ˆê³¼ë˜ì–´ ë§ˆì™•ì´ ì„¸ê³„ë¥¼ ë©¸ë§ì‹œì¼°ìŠµë‹ˆë‹¤.";
        }
    }
};

const Setup = {
    renderClasses: () => {
        const grid = document.querySelector('.class-grid'); grid.innerHTML = '';
        for (let k in CLASSES) {
            const c = CLASSES[k]; const el = document.createElement('div'); el.className = 'class-card';
            const img = getImgTag(k, 'shop-img', c.i); const imgHtml = img.includes('<img') ? img.replace('shop-img', 'img-asset') : `<div style="font-size:30px">${c.i}</div>`;
            el.innerHTML = `<div class="c-icon" style="height:60px;">${imgHtml}</div><div class="c-name">${c.n}</div><div class="c-desc">${c.desc}</div>`;
            el.onclick = () => Setup.selectClass(k); grid.appendChild(el);
        }
    },
    selectClass: (k) => {
        const p = State.p1; State.keyStat = CLASSES[k].main; p.job = k;
        if(k==='warrior'){ p.maxHp+=30; p.bonus.atkMax+=2; } else if(k==='knight'){ p.maxHp+=40; p.bonus.defMax+=2; } else if(k==='rogue'){ p.gold+=100; p.bonus.luckMax+=2; } else if(k==='hunter'){ p.bonus.atkMax+=1; p.bonus.moveMax+=1; } else if(k==='mage'){ p.maxHp-=20; p.bonus.atkMax+=3; } else if(k==='explorer'){ p.bonus.moveMax+=2; p.pot=2; }
        p.hp = p.maxHp;
        document.getElementById('screen-class').style.display = 'none'; document.getElementById('screen-setup').style.display = 'flex';
        document.getElementById('ui-job').innerText = CLASSES[k].n;
        const bSk = document.getElementById('btn-skill'); bSk.innerHTML = "<span style='font-size:10px; color:#aaa'>ë¯¸ê°œë°©</span><br>ìŠ¤í‚¬"; bSk.disabled = true;
        for(let i=0; i<100; i++) {
            let rank = 'common', color='#ccc', stat={mv:[1,3],at:[1,4],df:[1,4],lk:[0,1]};
            let r = Math.random();
            if(r < 0.1) { rank='legend'; color='gold'; stat={mv:[3,6], at:[8,12], df:[5,8], lk:[3,5]}; } else if(r < 0.3) { rank='rare'; color='violet'; stat={mv:[2,5], at:[5,8], df:[3,6], lk:[1,3]}; } else if(r < 0.6) { rank='uncommon'; color='skyblue'; stat={mv:[2,4], at:[3,6], df:[2,5], lk:[0,2]}; }
            State.cards.push({ id: i, name: Utils.randArr(FIRST_NAMES)+" "+Utils.randArr(LAST_NAMES), rank, color, move: Utils.rand(stat.mv[0], stat.mv[1]), atk: Utils.rand(stat.at[0], stat.at[1]), def: Utils.rand(stat.df[0], stat.df[1]), luck: Utils.rand(stat.lk[0], stat.lk[1]) });
        }
    },
    summon: () => {
        if(State.summonCnt >= 4) return;
        const idx = Utils.rand(0, State.cards.length-1); const card = State.cards.splice(idx, 1)[0]; State.hand.push(card); State.summonCnt++;
        const el = document.createElement('div'); el.className = `merc-card ${card.rank}`;
        el.innerHTML = `<div class="merc-name" style="color:${card.color}">${card.name}</div>ğŸ¦¶${card.move} âš”ï¸${card.atk}<br>ğŸ›¡ï¸${card.def} ğŸ€${card.luck}`;
        document.getElementById('gacha-list').appendChild(el); document.getElementById('btn-summon').innerText = `ì†Œí™˜ (${State.summonCnt}/4)`;
        if(State.summonCnt === 4) {
            document.getElementById('btn-summon').disabled = true;
            setTimeout(() => { document.getElementById('gacha-view').style.display='none'; document.getElementById('place-view').style.display='flex'; Setup.renderHand(); }, 800);
        }
    },
    renderHand: () => {
        const c = document.getElementById('hand'); c.innerHTML = '';
        State.hand.forEach(card => {
            const d = document.createElement('div'); d.className = 'dragger'; d.id = `card-${card.id}`; d.draggable = true; d.style.borderColor = card.color;
            d.innerHTML = `<div style="font-weight:bold; color:${card.color}; margin-bottom:3px;">${card.name}</div>ğŸ¦¶${card.move} âš”ï¸${card.atk}<br>ğŸ›¡ï¸${card.def} ğŸ€${card.luck}`;
            d.ondragstart = e => e.dataTransfer.setData('cid', card.id); c.appendChild(d);
        });
        document.querySelectorAll('.stat-slot').forEach(slot => {
            slot.ondragover = e => e.preventDefault();
            slot.ondrop = e => {
                const cid = e.dataTransfer.getData('cid'); const card = State.hand.find(x => x.id == cid); const type = slot.dataset.type;
                for(let k in State.slots) if(State.slots[k] === card) State.slots[k] = null;
                State.slots[type] = card; Setup.updateSlots();
            };
        });
    },
    updateSlots: () => {
        document.querySelectorAll('.dragger').forEach(e => e.classList.remove('placed'));
        for(let k in State.slots) {
            const card = State.slots[k]; const el = document.getElementById(`slot-${k}`);
            if(card) {
                document.getElementById(`card-${card.id}`).classList.add('placed'); el.classList.add('filled');
                el.innerHTML = `<span style="color:${card.color};margin-bottom:5px;">${card.name}</span><span style="font-size:16px;font-weight:bold;">${card[k]}</span>`;
            } else {
                el.classList.remove('filled'); const label = {move:'ì´ë™',atk:'ê³µê²©',def:'ë°©ì–´',luck:'ìš´'}[k];
                el.innerHTML = `${label}<br><span>-</span>`;
            }
        }
    },
    finish: () => {
        if(!State.slots.move || !State.slots.atk || !State.slots.def || !State.slots.luck) return alert("ëª¨ë“  ìŠ¬ë¡¯ì„ ì±„ì›Œì£¼ì„¸ìš”.");
        State.p1.stats = { move: State.slots.move.move, atk: State.slots.atk.atk, def: State.slots.def.def, luck: State.slots.luck.luck };
        let pool = []; for(let i=0; i<4; i++) pool.push(State.cards[Utils.rand(0, State.cards.length-1)]);
        pool.sort((a,b) => b.atk - a.atk); const ca = pool.shift(); pool.sort((a,b) => b.def - a.def); const cd = pool.shift(); pool.sort((a,b) => b.move - a.move); const cm = pool.shift(); const cl = pool[0];
        State.p2.stats = { move: cm.move, atk: ca.atk, def: cd.def, luck: cl.luck };
        document.getElementById('screen-setup').style.display='none'; document.getElementById('screen-game').style.display='flex';
        Logic.initGame();
    }
};

const Game = {
    onSkillBtnClick: () => {
        if(State.p1.subJob) {
            if(State.p1.subJob.type === 'active') {
                if(State.p1.skillCD > 0) Utils.popup("ìŠ¤í‚¬ ì •ë³´", `<b>${State.p1.subJob.sn}</b><br>${State.p1.subJob.desc}<br><br><span style="color:red">ì¿¨íƒ€ì„ ì¤‘ì…ë‹ˆë‹¤ (${State.p1.skillCD}í„´)</span>`, null);
                else Utils.popup("ìŠ¤í‚¬ ì‚¬ìš©", `<b>${State.p1.subJob.sn}</b><br>${State.p1.subJob.desc}<br><br>ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, null, [{txt:"ì‚¬ìš©", act: Game.useClassSkill}, {txt:"ì·¨ì†Œ", act: ()=>document.getElementById('modal-gen').style.display='none'}]);
            } else Utils.popup("ìŠ¤í‚¬ ì •ë³´ (íŒ¨ì‹œë¸Œ)", `<b>${State.p1.subJob.sn}</b><br>${State.p1.subJob.desc}<br><br>ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.`, null);
        }
    },
    roll: (isAi = false) => {
        if(!isAi && (State.isMoving || State.isProcessing)) return;
        State.isMoving = true; State.isProcessing = true; document.getElementById('btn-roll').disabled = true;
        const p = (State.turn === 'P1') ? State.p1 : State.p2; const s = Logic.getStats(p); const steps = Utils.rand(s.mvMin, s.mvMax);
        Utils.floatText(p.pos, `${steps}ì¹¸`, "white"); Logic.moveStep(p, steps);
    },
    useClassSkill: () => {
        if(State.turn !== 'P1' || State.isMoving || State.isProcessing || State.skillUsedTurn || State.p1.skillCD > 0) return;
        document.getElementById('modal-gen').style.display='none';
        if(State.p1.subJob && State.p1.subJob.type === 'active') {
            State.skillUsedTurn = true; State.p1.skillCD = 3; State.activeSkillEffect = 'fireball'; 
            Utils.floatText(State.p1.pos, "ğŸ”¥ì¥ì „ë¨", "orange"); UI.update();
            const bSk = document.getElementById('btn-skill');
            bSk.innerHTML = `<span style="font-size:10px">[ì•¡í‹°ë¸Œ]</span><br>${State.p1.subJob.sn}<br><span style="color:red; font-size:10px">ì¿¨íƒ€ì„ (3)</span>`;
        }
    },
    usePotion: () => {
        if(State.turn !== 'P1' || State.isMoving || State.isProcessing) return;
        if(State.p1.pot <= 0 || State.p1.hp >= State.p1.maxHp) return;
        State.p1.pot--; State.p1.hp = Math.min(State.p1.maxHp, State.p1.hp + 50);
        if(State.p1.subJob && State.p1.subJob.id === 'alchemist') { State.boss.hp = Math.max(0, State.boss.hp - 10); Utils.floatText(49, "-10HP(ë…)", "purple"); }
        Utils.floatText(State.p1.pos, "+50HP", "pink"); UI.update();
    },
    toggleCamera: () => {
        State.cameraLocked = !State.cameraLocked; 
        const btn = document.getElementById('btn-cam');
        if(State.cameraLocked) {
            btn.classList.add('active'); btn.innerHTML = "ğŸ¥ì‹œì ê³ ì •";
            const p = (State.turn === 'P1') ? State.p1 : State.p2;
            Utils.centerCamera(p.pos); Utils.floatText(p.pos, "ì‹œì  ê³ ì •ë¨", "lime");
        } else {
            btn.classList.remove('active'); btn.innerHTML = "ğŸ”“ììœ ì‹œì ";
            Utils.floatText((State.turn === 'P1' ? State.p1.pos : State.p2.pos), "ììœ  ì‹œì ", "white");
        }
    }
};

const Shop = {
    open: () => { 
        if(State.turn !== 'P1') { return alert("ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤."); }
        if(State.isMoving || State.isProcessing) { return alert("í–‰ë™ ì¤‘ì—ëŠ” ìƒì ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
        Shop.render(); document.getElementById('modal-shop').style.display='flex'; 
    },
    close: () => document.getElementById('modal-shop').style.display='none',
    
    render: () => {
        const c = document.getElementById('shop-items'); c.innerHTML = '';
        c.innerHTML += `<div class="shop-header-gold">ğŸ’° ë³´ìœ : ${State.p1.gold} G</div>`;
        c.innerHTML += `<div class="shop-grid" id="shop-grid"></div>`;
        const grid = document.getElementById('shop-grid');
        const cats = { cons: {n:"ğŸ§ª ì†Œëª¨í’ˆ", list:[]}, s: {n:"ğŸ‘Ÿ ì‹ ë°œ", list:[]}, w: {n:"âš”ï¸ ë¬´ê¸°", list:[]}, a: {n:"ğŸ›¡ï¸ ë°©ì–´êµ¬", list:[]}, acc: {n:"ğŸ’ ì¥ì‹ êµ¬", list:[]} };
        const makeCard = (icon, name, desc, price, onclick) => {
            return `<div class="shop-card"><div class="shop-icon">${icon}</div><div class="shop-right-col"><div class="item-name">${name}</div><div class="item-stat">${desc}</div><button class="buy-btn" onclick="${onclick}">${price} G</button></div></div>`;
        };
        cats.cons.list.push({ html: makeCard('ğŸ§ª', 'íšŒë³µ ë¬¼ì•½', 'ì²´ë ¥ +50 íšŒë³µ', 50, "Shop.buy('pot', 50)") });
        cats.cons.list.push({ html: makeCard('ğŸ²', 'ëœë¤ ê°•í™”', 'ëŠ¥ë ¥ì¹˜ ëœë¤ +1', 100, "Shop.buy('up', 100)") });
        ITEMS_DB.forEach(item => {
            const iconDisplay = getImgTag(item.n, 'shop-img', item.icon);
            const html = makeCard(iconDisplay, item.n, item.desc, item.cost, `Shop.buyItem('${item.n}')`);
            if(cats[item.type]) cats[item.type].list.push({html});
        });
        for(let k in cats) {
            if(cats[k].list.length > 0) {
                grid.innerHTML += `<div class="shop-cat-header">${cats[k].n}</div>`;
                cats[k].list.forEach(i => grid.innerHTML += i.html);
            }
        }
    },
    buy: (t, cost) => {
        if(State.p1.gold < cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        State.p1.gold -= cost;
        if(t==='pot') { State.p1.hp = Math.min(State.p1.maxHp, State.p1.hp + 50); Utils.floatText(State.p1.pos, "+50HP", "pink"); }
        else if(t==='up') { Logic.applyUpgrade(State.p1, ['move','atk','def','luck'][Utils.rand(0,3)], Math.random()<0.5); }
        UI.update(); Shop.render();
    },
    buyItem: (name) => {
        const item = ITEMS_DB.find(x => x.n === name);
        if(State.p1.gold < item.cost) return alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
        State.p1.gold -= item.cost;
        const res = Logic.equipItem(State.p1, item); Utils.popup("êµ¬ë§¤ ì™„ë£Œ", `${item.n}ì„(ë¥¼) êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤.<br><br>${res.msg}`, null);
        UI.update(); Shop.render();
    }
};

const UI = {
    update: () => {
        // 1. ê¸°ì¡´ ë§ë“¤ ì œê±°
        document.querySelectorAll('.pawn').forEach(e => e.remove());

        const renderPawn = (p, cls, jobKey, icon) => {
            const targetTile = document.getElementById(`tile-${p.pos}`);
            if (targetTile) {
                const wrapper = document.createElement('div');
                wrapper.className = `pawn ${cls}`;
                // ì´ë¯¸ì§€ë¥¼ ê°ì‹¸ëŠ” êµ¬ì¡°ë¡œ CSS ì• ë‹ˆë©”ì´ì…˜ ìµœì í™”
                wrapper.innerHTML = getImgTag(jobKey, 'pawn-img', icon);
                targetTile.appendChild(wrapper);
            }
        };

        // ìœ ì € ë Œë”ë§
        const p1Job = State.p1.subJob ? State.p1.subJob.id : State.p1.job;
        const p1Icon = State.p1.subJob ? State.p1.subJob.i : CLASSES[State.p1.job].i;
        renderPawn(State.p1, 'p1', p1Job, p1Icon);

        // AI ë Œë”ë§
        if (!State.aiMerged) {
            renderPawn(State.p2, 'p2', 'enemy', 'ğŸ‘º');
        }

        // --- ë‚˜ë¨¸ì§€ HUD ì—…ë°ì´íŠ¸ ë¡œì§ì€ ë™ì¼í•˜ê²Œ ìœ ì§€ ---
        const renP = (p, id) => {
            const el = document.getElementById(id); const s = Logic.getStats(p);
            const hpPct = Math.max(0, (p.hp/p.maxHp)*100);
            const fmt = (total, base) => { const bonus = total - base; return bonus > 0 ? `${total}<span style="color:#00e676; font-size:10px;">(+${bonus})</span>` : `${total}`; };
            const mvStr = `${fmt(s.mvMin, 1)}~${fmt(s.mvMax, p.stats.move)}`;
            const atStr = `${fmt(s.atMin, 1)}~${fmt(s.atMax, p.stats.atk)}`;
            const dfStr = `${fmt(s.dfMin, 1)}~${fmt(s.dfMax, p.stats.def)}`;
            const lkStr = `${fmt(s.lkMin, 0)}~${fmt(s.lkMax, p.stats.luck)}`;
            const eq = p.equip;
            const eqHtml = p.isAi ? '' : `<div class="equip-row"><div class="equip-slot ${eq.s?'filled':''}">${eq.s ? getImgTag(eq.s.n, 'item-img', eq.s.icon) : 'ğŸ‘Ÿ'}</div><div class="equip-slot ${eq.w?'filled':''}">${eq.w ? getImgTag(eq.w.n, 'item-img', eq.w.icon) : 'âš”ï¸'}</div><div class="equip-slot ${eq.a?'filled':''}">${eq.a ? getImgTag(eq.a.n, 'item-img', eq.a.icon) : 'ğŸ›¡ï¸'}</div><div class="equip-slot ${eq.acc?'filled':''}">${eq.acc ? getImgTag(eq.acc.n, 'item-img', eq.acc.icon) : 'ğŸ’'}</div></div><div class="art-row">${p.artifacts.map(a => `<div class="art-slot" title="${a.desc}">${a.icon}</div>`).join('')}</div>`;
            el.innerHTML = `<div class="stat-line" style="color:white; font-weight:bold;">${p.name} <span style="font-size:10px">${p.hp}/${p.maxHp}</span></div><div class="hp-wrap"><div class="hp-fill ${p.id==='P1'?'p1-hp':'p2-hp'}" style="width:${hpPct}%"></div></div><div class="stat-line"><span>ì´ë™</span><span>${mvStr}</span></div><div class="stat-line"><span>ê³µê²©</span><span>${atStr}</span></div><div class="stat-line"><span>ë°©ì–´</span><span>${dfStr}</span></div><div class="stat-line"><span>ìš´</span><span>${lkStr}</span></div>${eqHtml}`;
        };
        renP(State.p1, 'hud-p1'); renP(State.p2, 'hud-p2');
        document.getElementById('ui-gold').innerText = `${State.p1.gold} G`; document.getElementById('ui-lv').innerText = `Lv.${State.p1.lv}`; document.getElementById('ui-pot').innerText = State.p1.pot;
        const bossHpPct = (State.boss.hp / State.boss.maxHp) * 100;
        document.getElementById('boss-hp-fill').style.width = `${Math.min(100, Math.max(0, bossHpPct))}%`;
        document.getElementById('boss-hp-txt').innerText = `ë§ˆì™• HP: ${State.boss.hp} / ${State.boss.maxHp}`;
    }
};
Setup.renderClasses();
</script>
</body>

</html>


